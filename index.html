<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>IronPath GM</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { 
            --tg-bg: var(--tg-theme-bg-color, #121212);
            --tg-text: var(--tg-theme-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #9ca3af);
            --tg-link: var(--tg-theme-link-color, #3b82f6);
            --tg-btn: var(--tg-theme-button-color, #3b82f6);
            --tg-btn-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary: var(--tg-theme-secondary-bg-color, #1f2937);
            
            --green: #10b981;
            --red: #ef4444;
            --gold: #f59e0b;
            --purple: #8b5cf6;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--tg-bg); color: var(--tg-text); 
            margin: 0; padding: 16px; max-width: 600px; margin: 0 auto; 
            -webkit-tap-highlight-color: transparent; touch-action: manipulation;
        }

        .screen { display: none; animation: fade 0.25s ease-out; }
        .active-screen { display: block; }
        @keyframes fade { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .card { 
            background: var(--tg-secondary); padding: 20px; 
            border-radius: 20px; margin-bottom: 16px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: relative;
        }

        h1, h2, h3 { margin: 0 0 10px 0; font-weight: 800; letter-spacing: -0.5px; }
        p { color: var(--tg-hint); font-size: 14px; line-height: 1.5; margin-bottom: 15px; }

        .btn { 
            width: 100%; padding: 14px; border: none; border-radius: 14px; 
            font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-primary { background: var(--tg-btn); color: var(--tg-btn-text); }
        .btn-success { background: var(--green); color: #fff; }
        .btn-outline { background: transparent; border: 1px solid var(--tg-hint); color: var(--tg-hint); font-size: 13px; }
        .btn:active { transform: scale(0.98); opacity: 0.9; }

        input, select { 
            width: 100%; padding: 14px; margin-bottom: 12px; 
            background: var(--tg-bg); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; 
            color: var(--tg-text); font-size: 16px; box-sizing: border-box; outline: none;
            -webkit-appearance: none;
        }
        input:focus { border-color: var(--tg-link); }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; text-align: center; }
        .stat-val { font-size: 20px; font-weight: 800; color: var(--tg-link); }
        .stat-label { font-size: 10px; text-transform: uppercase; color: var(--tg-hint); margin-top: 4px; }

        .char-container { text-align: center; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 15px; }
        .char-icon { font-size: 72px; display: block; margin-bottom: 5px; animation: bounce 3s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        
        .xp-bar-bg { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-top: 8px; overflow: hidden; }
        .xp-bar-fill { height: 100%; background: linear-gradient(90deg, var(--tg-link), var(--purple)); width: 0%; transition: width 0.5s; }

        .list-item { 
            padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); 
            display: flex; justify-content: space-between; align-items: center;
        }
        .del-btn { 
            color: var(--red); padding: 6px 10px; font-size: 14px; cursor: pointer; 
            background: rgba(239, 68, 68, 0.1); border-radius: 8px; margin-left: 10px;
        }

        .diff-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-top: 5px; background: rgba(255,255,255,0.1);}
        .diff-pos { background: rgba(16, 185, 129, 0.2); color: var(--green); }
        .diff-neg { background: rgba(239, 68, 68, 0.2); color: var(--red); }
        
        .hint-block {
            color: var(--gold); font-size: 12px; margin: 10px 0;
            background: rgba(245, 158, 11, 0.1); padding: 10px;
            border-radius: 8px; border-left: 3px solid var(--gold); display: none;
        }
        .hint-block.visible { display: block; }
        .hidden { display: none !important; }
        
        .input-row { display: flex; gap: 10px; }
        .input-group { flex: 1; position: relative; }
        .input-label { font-size: 11px; color: var(--tg-hint); margin-bottom: 4px; display: flex; justify-content: space-between; }
        
        .pr-badge { color: var(--gold); font-weight: bold; font-size: 11px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }

        /* Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ */
        #toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--gold); color: #000; padding: 10px 20px; border-radius: 20px;
            font-weight: bold; z-index: 1000; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

    <div id="toast">üèÜ –ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥!</div>

    <div id="screen-onboarding" class="screen">
        <div class="card" style="text-align: center; padding-top: 40px; min-height: 300px; display: flex; flex-direction: column; justify-content: space-between;">
            <div>
                <div style="font-size: 70px; margin-bottom: 20px;">üõ°Ô∏è</div>
                <h2>IronPath</h2>
                <p>–¢—Ä–µ–Ω–∏—Ä—É–π—Å—è —Å —É–º–æ–º.</p>
                <p>–ú—ã –∏—Å–ø—Ä–∞–≤–∏–ª–∏ —Ñ–∏–∑–∏–∫—É, –¥–æ–±–∞–≤–∏–ª–∏ —Ä–µ–∫–æ—Ä–¥—ã –∏ —Å–¥–µ–ª–∞–ª–∏ –≤—Å—ë —á–µ—Å—Ç–Ω–æ.</p>
            </div>
            <button class="btn btn-primary" onclick="showScreen('screen-profile')">–ù–∞—á–∞—Ç—å –ø—É—Ç—å</button>
        </div>
    </div>

    <div id="screen-profile" class="screen">
        <div class="card">
            <h2>–ü–∞—Å–ø–æ—Ä—Ç –∞—Ç–ª–µ—Ç–∞</h2>
            <div class="input-row">
                <div class="input-group">
                    <label class="input-label">–í–µ—Å (–∫–≥)</label>
                    <input type="number" id="prof-weight" placeholder="80" inputmode="decimal">
                </div>
                <div class="input-group">
                    <label class="input-label">–†–æ—Å—Ç (—Å–º)</label>
                    <input type="number" id="prof-height" placeholder="175" inputmode="numeric">
                </div>
            </div>
            <div class="input-row">
                <div class="input-group">
                    <label class="input-label">–í–æ–∑—Ä–∞—Å—Ç</label>
                    <input type="number" id="prof-age" placeholder="25" inputmode="numeric">
                </div>
                <div class="input-group">
                    <label class="input-label">–ü–æ–ª</label>
                    <select id="prof-gender">
                        <option value="male">–ú—É–∂—á–∏–Ω–∞</option>
                        <option value="female">–ñ–µ–Ω—â–∏–Ω–∞</option>
                    </select>
                </div>
            </div>
            <label class="input-label">–¶–µ–ª—å</label>
            <select id="prof-goal">
                <option value="strength">–°–∏–ª–∞ (–ü–∞—É—ç—Ä–ª–∏—Ñ—Ç–∏–Ω–≥) üí™</option>
                <option value="muscle">–ì–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è (–ú–∞—Å—Å–∞) üèãÔ∏è</option>
                <option value="health">–ó–¥–æ—Ä–æ–≤—å–µ –∏ –¢–æ–Ω—É—Å ü´Ä</option>
                <option value="fatloss">–†–µ–ª—å–µ—Ñ / –ü–æ—Ö—É–¥–µ–Ω–∏–µ üî•</option>
            </select>
            <button class="btn btn-primary" style="margin-top: 10px;" onclick="saveProfile()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>

    <div id="screen-main" class="screen">
        <div class="card">
            <div class="char-container">
                <span class="char-icon" id="main-char-icon">üê£</span>
                <div style="font-weight: bold; font-size: 18px;" id="main-char-rank">–ù–æ–≤–∏—á–æ–∫</div>
                <div class="xp-bar-bg"><div class="xp-bar-fill" id="xp-fill"></div></div>
                <div style="display:flex; justify-content:space-between; font-size: 11px; color: var(--tg-hint); margin-top: 5px;">
                    <span id="main-char-xp">0 XP</span>
                    <span id="main-char-next">–¶–µ–ª—å: 100</span>
                </div>
            </div>
            <div class="stat-grid">
                <div><div class="stat-val" id="stat-xp">0</div><div class="stat-label">–í—Å–µ–≥–æ XP</div></div>
                <div><div class="stat-val" id="stat-count">0</div><div class="stat-label">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div></div>
                <div><div class="stat-val" id="stat-lvl">1</div><div class="stat-label">–£—Ä–æ–≤–µ–Ω—å</div></div>
            </div>
        </div>

        <div class="card">
            <h3>–ó–∞–ø–∏—Å—å –ø–æ–¥—Ö–æ–¥–∞</h3>
            <select id="select-cat" onchange="updateExList()">
                <option value="chest">–ì—Ä—É–¥—å</option>
                <option value="back">–°–ø–∏–Ω–∞</option>
                <option value="legs">–ù–æ–≥–∏</option>
                <option value="shoulders">–ü–ª–µ—á–∏</option>
                <option value="arms">–†—É–∫–∏</option>
                <option value="abs">–ü—Ä–µ—Å—Å / –ö–æ—Ä</option>
                <option value="cardio">–ö–∞—Ä–¥–∏–æ</option>
            </select>
            <select id="select-ex" onchange="adaptInputs()"></select>
            
            <div id="hints-container">
                <div id="hint-unilateral" class="hint-block">ü¶µ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –Ω–∞ –æ–¥–Ω—É —Å—Ç–æ—Ä–æ–Ω—É. –í–≤–æ–¥–∏ –ø–æ–≤—Ç–æ—Ä—ã –¥–ª—è –æ–¥–Ω–æ–π –Ω–æ–≥–∏/—Ä—É–∫–∏.</div>
                <div id="hint-dumbbell" class="hint-block">üèãÔ∏è‚Äç‚ôÇÔ∏è –í–≤–æ–¥–∏ –≤–µ—Å <b>–æ–¥–Ω–æ–π</b> –≥–∞–Ω—Ç–µ–ª–∏. –°–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ –ø–æ—Å—á–∏—Ç–∞–µ—Ç –æ–±—â–∏–π –æ–±—ä–µ–º.</div>
                <div id="hint-bodyweight" class="hint-block">‚öñÔ∏è –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —Å–æ —Å–≤–æ–∏–º –≤–µ—Å–æ–º. –ü–∏—à–∏ 0, –µ—Å–ª–∏ –±–µ–∑ –¥–æ–ø. –≤–µ—Å–∞.</div>
                <div id="hint-machine" class="hint-block">ü§ñ –¢—Ä–µ–Ω–∞–∂–µ—Ä. –¢–≤–æ–π –≤–µ—Å —Ç–µ–ª–∞ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ —Ñ–∏–∑–∏–∫–µ.</div>
                <div id="hint-facepull" class="hint-block">üß∂ –û–±—ã—á–Ω–æ –¥–µ–ª–∞–µ—Ç—Å—è –≤ –±–ª–æ–∫–µ (–∫–∞–Ω–∞—Ç–∫–∞).</div>
            </div>

            <div id="input-container-strength" class="input-row">
                <div class="input-group">
                    <label id="label-w" class="input-label">
                        <span>–í–µ—Å (–∫–≥)</span>
                        <span id="pr-display" class="pr-badge"></span>
                    </label>
                    <input type="number" id="input-w" inputmode="decimal">
                </div>
                <div class="input-group">
                    <label id="label-r" class="input-label">–ü–æ–≤—Ç–æ—Ä—ã</label>
                    <input type="number" id="input-r" inputmode="numeric">
                </div>
            </div>

            <div id="input-container-cardio" class="hidden">
                <label class="input-label">–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å</label>
                <select id="input-cardio-intensity"></select>
                <label class="input-label">–í—Ä–µ–º—è (–º–∏–Ω—É—Ç—ã)</label>
                <input type="number" id="input-cardio-time" placeholder="–ú–∏–Ω" inputmode="numeric">
            </div>

            <button class="btn btn-primary" style="margin-top:12px;" onclick="addSet()">–ó–∞–ø–∏—Å–∞—Ç—å</button>
        </div>

        <div id="current-session-block" class="card hidden">
            <h3 id="session-title">–°–µ–π—á–∞—Å: 0 XP</h3>
            <div id="current-list"></div>
            <button class="btn btn-success" style="margin-top: 15px;" onclick="finishWorkout()">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
        </div>

        <div class="card">
            <h3 style="font-size:14px; opacity:0.7">–ò—Å—Ç–æ—Ä–∏—è</h3>
            <div id="history-list" style="max-height: 300px; overflow-y: auto;"></div>
            <button class="btn btn-outline" style="border-color: var(--red); color: var(--red); margin-top:15px; width:100%" onclick="safeReset()">üß® –°–±—Ä–æ—Å –≤—Å–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</button>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <div class="card" style="text-align: center;">
            <div style="font-size: 60px; margin-bottom: 10px;">üèÜ</div>
            <h2 id="res-title">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
            <div id="res-diff-badge" class="diff-badge hidden"></div>
            
            <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin: 20px 0;">
                <div style="font-size: 12px; opacity: 0.7;">–ü–æ–ª—É—á–µ–Ω–æ –æ–ø—ã—Ç–∞</div>
                <div style="font-size: 42px; font-weight: 900; color: var(--gold);" id="res-xp">+0 XP</div>
            </div>

            <div class="stat-grid">
                <div><div class="stat-val" id="res-vol">0</div><div class="stat-label">–û–±—ä–µ–º</div></div>
                <div><div class="stat-val" id="res-kcal">0</div><div class="stat-label">–ö–∫–∞–ª</div></div>
                <div><div class="stat-val" id="res-time">0</div><div class="stat-label">–ú–∏–Ω</div></div>
            </div>

            <div id="res-msg" style="margin: 15px 0; font-size: 14px; font-style: italic; color: var(--tg-hint);"></div>
            <div id="res-tip" class="hint-block" style="display:block; text-align: left; margin-top: 15px; background: rgba(59, 130, 246, 0.1); border-color: var(--tg-link); color: var(--tg-text);"></div>
            
            <button class="btn btn-primary" style="margin-top: 20px;" onclick="closeResult()">–í –º–µ–Ω—é</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        /* TYPES: 0=–û–±—ã—á–Ω–æ–µ, 1=–°–≤–æ–π–í–µ—Å, 2=–°—Ç–∞—Ç–∏–∫–∞, 3=–ö–∞—Ä–¥–∏–æ, 4=–¢—Ä–µ–Ω–∞–∂–µ—Ä
           MULT: 1=–û–±—ã—á, 2=–ì–∞–Ω—Ç–µ–ª–∏(–¥–ª—è —Ç–æ–Ω–Ω–∞–∂–∞), 1=–û–¥–Ω–∞–°—Ç–æ—Ä–æ–Ω–∞(–¢—è–≥–∞)
           FLAGS: db=dumbell_hint, uni=unilateral_hint, mach=machine_hint
        */
        const EX_DB = {
            chest: [
                ["–ñ–∏–º –ª–µ–∂–∞ (–®—Ç–∞–Ω–≥–∞)", 0, 1], ["–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –ª–µ–∂–∞", 0, 2, {db:true}],
                ["–ñ–∏–º –ø–æ–¥ —É–≥–ª–æ–º (–®—Ç–∞–Ω–≥–∞)", 0, 1], ["–ñ–∏–º –ø–æ–¥ —É–≥–ª–æ–º (–ì–∞–Ω—Ç–µ–ª–∏)", 0, 2, {db:true}],
                ["–û—Ç–∂–∏–º–∞–Ω–∏—è", 1, 0], ["–ë—Ä—É—Å—å—è", 1, 0], ["–ë–∞–±–æ—á–∫–∞", 4, 1, {mach:true}]
            ],
            back: [
                ["–°—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞", 0, 1], ["–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è", 1, 0], 
                ["–¢—è–≥–∞ —à—Ç–∞–Ω–≥–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ", 0, 1], ["–¢—è–≥–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞", 4, 1, {mach:true}], 
                ["–¢—è–≥–∞ –Ω–∏–∂–Ω–µ–≥–æ –±–ª–æ–∫–∞", 4, 1, {mach:true}], 
                ["–¢—è–≥–∞ –≥–∞–Ω—Ç–µ–ª–∏ (–æ–¥–Ω–æ–π —Ä—É–∫–æ–π)", 0, 1, {uni:true}], // –£–±—Ä–∞–ª–∏ db:true —á—Ç–æ–±—ã –Ω–µ –ø—É—Ç–∞—Ç—å
                ["–ì–∏–ø–µ—Ä—ç–∫—Å—Ç–µ–Ω–∑–∏—è", 1, 0], 
                ["–ü—É–ª–æ–≤–µ—Ä", 0, 1, {}] // –£–±—Ä–∞–ª–∏ db:true
            ],
            legs: [
                ["–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è (–®—Ç–∞–Ω–≥–∞)", 0, 1], ["–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è (–ö—É–±–æ–∫/–ì–∞–Ω—Ç–µ–ª—å)", 0, 1, {}],
                ["–ñ–∏–º –Ω–æ–≥–∞–º–∏", 4, 1, {mach:true}], ["–†—É–º—ã–Ω—Å–∫–∞—è —Ç—è–≥–∞", 0, 1],
                ["–í—ã–ø–∞–¥—ã (–ì–∞–Ω—Ç–µ–ª–∏)", 0, 2, {db:true, uni:true}], ["–í—ã–ø–∞–¥—ã (–°–≤–æ–π –≤–µ—Å)", 1, 0, {uni:true}],
                ["–ë–æ–ª–≥–∞—Ä—Å–∫–∏–µ –≤—ã–ø–∞–¥—ã", 0, 2, {db:true, uni:true}], ["–†–∞–∑–≥–∏–±–∞–Ω–∏–µ –Ω–æ–≥", 4, 1, {mach:true}], ["–°–≥–∏–±–∞–Ω–∏–µ –Ω–æ–≥", 4, 1, {mach:true}]
            ],
            shoulders: [
                ["–ê—Ä–º–µ–π—Å–∫–∏–π –∂–∏–º", 0, 1], ["–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π —Å–∏–¥—è", 0, 2, {db:true}],
                ["–ú–∞—Ö–∏ –≤ —Å—Ç–æ—Ä–æ–Ω—ã", 0, 2, {db:true}], ["–ú–∞—Ö–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ", 0, 2, {db:true}], 
                ["–¢—è–≥–∞ –∫ –ª–∏—Ü—É", 4, 1, {face:true}]
            ],
            arms: [
                ["–ü–æ–¥—ä–µ–º –Ω–∞ –±–∏—Ü–µ–ø—Å (–®—Ç–∞–Ω–≥–∞)", 0, 1], ["–ü–æ–¥—ä–µ–º –≥–∞–Ω—Ç–µ–ª–µ–π (–ë–∏—Ü–µ–ø—Å)", 0, 2, {db:true}], ["–ú–æ–ª–æ—Ç–∫–∏", 0, 2, {db:true}],
                ["–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∂–∏–º", 0, 1], ["–†–∞–∑–≥–∏–±–∞–Ω–∏–µ –Ω–∞ –±–ª–æ–∫–µ", 4, 1, {mach:true}]
            ],
            abs: [
                ["–°–∫—Ä—É—á–∏–≤–∞–Ω–∏—è", 1, 0], ["–ü–æ–¥—ä–µ–º –Ω–æ–≥", 1, 0], 
                ["–ü–ª–∞–Ω–∫–∞", 2, 0], ["–†—É—Å—Å–∫–∏–π —Ç–≤–∏—Å—Ç", 1, 0]
            ],
            cardio: [
                ["–ë–µ–≥ (–°—Ä–µ–¥–Ω–∏–π)", 3, 0], ["–°–ø—Ä–∏–Ω—Ç (–ú–∞–∫—Å–∏–º—É–º)", 3, 0], ["–•–æ–¥—å–±–∞", 3, 0], 
                ["–≠–ª–ª–∏–ø—Å", 3, 0], ["–í–µ–ª–æ—Ç—Ä–µ–Ω–∞–∂–µ—Ä", 3, 0], ["–ì—Ä–µ–±–ª—è", 3, 0]
            ]
        };

        const LEVELS = [
            { xp: 0, icon: "ü•ö", rank: "–Ø–π—Ü–æ" }, { xp: 500, icon: "üê£", rank: "–ù–æ–≤–∏—á–æ–∫" },
            { xp: 2000, icon: "üê•", rank: "–õ—é–±–∏—Ç–µ–ª—å" }, { xp: 5000, icon: "üêì", rank: "–ë–æ–µ—Ü" },
            { xp: 12000, icon: "üêó", rank: "–ê—Ç–ª–µ—Ç" }, { xp: 30000, icon: "ü¶ç", rank: "–ú–∞—à–∏–Ω–∞" },
            { xp: 70000, icon: "ü¶ñ", rank: "–¢–∏—Ç–∞–Ω" }, { xp: 150000, icon: "üëë", rank: "–ö–æ—Ä–æ–ª—å" }
        ];

        const TIPS = {
            strength: ["–°–∏–ª–∞ —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–¥—ã—Ö–∞. 3-5 –º–∏–Ω—É—Ç –º–µ–∂–¥—É —Ç—è–∂–µ–ª—ã–º–∏ —Å–µ—Ç–∞–º–∏ ‚Äî –Ω–æ—Ä–º–∞.", "–ü—Ä–æ–≥—Ä–µ—Å—Å–∏—è –Ω–∞–≥—Ä—É–∑–æ–∫: –¥–æ–±–∞–≤–ª—è–π –≤–µ—Å –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä—ã –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é."],
            muscle: ["–í—Ä–µ–º—è –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π: –¥–µ–ª–∞–π –Ω–µ–≥–∞—Ç–∏–≤–Ω—É—é —Ñ–∞–∑—É (–æ–ø—É—Å–∫–∞–Ω–∏–µ) 2-3 —Å–µ–∫—É–Ω–¥—ã.", "–§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –º—ã—â—Ü–µ, –∞ –Ω–µ –Ω–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ –≤–µ—Å–∞."],
            fatloss: ["–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤–Ω–µ –∑–∞–ª–∞ —Å–∂–∏–≥–∞–µ—Ç –±–æ–ª—å—à–µ, —á–µ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ (NEAT).", "–°–æ—Ö—Ä–∞–Ω—è–π —Å–∏–ª–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –º—ã—à—Ü—ã."],
            health: ["–°–ª—É—à–∞–π —Å—É—Å—Ç–∞–≤—ã. –ë–æ–ª—å ¬´–ø–ª–æ—Ö–∞—è¬ª –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –º—ã—à–µ—á–Ω–æ–π.", "–†–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å –±—å–µ—Ç –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å."]
        };

        // –ù–∞—É—á–Ω—ã–µ MET-—ã (Intensity key maps to these values)
        const MET_CARDIO = {
            "–ë–µ–≥ (–°—Ä–µ–¥–Ω–∏–π)": {3:8, 6:9.8, 9:11.5, 11:12.5},
            "–°–ø—Ä–∏–Ω—Ç (–ú–∞–∫—Å–∏–º—É–º)": {3:12, 6:15, 9:19, 11:23}, 
            "–•–æ–¥—å–±–∞": {3:2.5, 5:3.5, 7:5.0}, // Key is input intensity value
            "–≠–ª–ª–∏–ø—Å": {3:5, 6:7, 9:9, 11:10},
            "–í–µ–ª–æ—Ç—Ä–µ–Ω–∞–∂–µ—Ä": {3:5, 6:7, 9:9.5, 11:11},
            "–ì—Ä–µ–±–ª—è": {3:6, 6:8.5, 9:12, 11:14}
        };

        let profile = JSON.parse(localStorage.getItem('ip_profile'));
        let history = JSON.parse(localStorage.getItem('ip_history')) || [];
        let currentSession = JSON.parse(localStorage.getItem('ip_current')) || [];
        let personalRecords = JSON.parse(localStorage.getItem('ip_prs')) || {};
        let totalXP = parseInt(localStorage.getItem('ip_xp')) || 0;
        let lastExName = null; 

        init();

        function init() {
            tg.ready();
            if (!profile) showScreen('screen-onboarding');
            else { showScreen('screen-main'); updateExList(); renderMain(); }
        }

        function updateExList() {
            const cat = document.getElementById('select-cat').value;
            const exSelect = document.getElementById('select-ex');
            exSelect.innerHTML = EX_DB[cat].map((ex, idx) => `<option value="${idx}">${ex[0]}</option>`).join('');
            adaptInputs();
        }

        function adaptInputs() {
            const cat = document.getElementById('select-cat').value;
            const exIdx = document.getElementById('select-ex').value;
            const [name, type, mult, flags] = EX_DB[cat][exIdx];
            const f = flags || {};

            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ PR
            const prEl = document.getElementById('pr-display');
            const currentPR = personalRecords[name] || 0;
            prEl.innerText = (type !== 3 && currentPR > 0) ? `üèÜ PR: ${currentPR}–∫–≥` : '';

            const strBlock = document.getElementById('input-container-strength');
            const cardioBlock = document.getElementById('input-container-cardio');
            
            document.querySelectorAll('.hint-block').forEach(el => el.classList.remove('visible'));
            
            if (lastExName !== name) {
                document.getElementById('input-w').value = ''; 
                document.getElementById('input-r').value = '';
            }
            
            if (type === 3) { // CARDIO
                strBlock.classList.add('hidden');
                cardioBlock.classList.remove('hidden');
                const iSelect = document.getElementById('input-cardio-intensity');
                
                let iMap = {3: "–õ–∞–π—Ç", 6: "–°—Ä–µ–¥–Ω–µ", 9: "–¢—è–∂–µ–ª–æ", 11: "–ú–∞–∫—Å–∏–º—É–º"};
                if (name === "–•–æ–¥—å–±–∞") iMap = {3: "–ü—Ä–æ–≥—É–ª–∫–∞", 5: "–ë–æ–¥—Ä—ã–π —à–∞–≥", 7: "–í –≥–æ—Ä—É / –°–ø–µ—à–∫–∞"};
                
                iSelect.innerHTML = Object.entries(iMap).map(([val, txt]) => 
                    `<option value="${val}" ${val==6?'selected':''}>${txt}</option>`
                ).join('');
            } else {
                strBlock.classList.remove('hidden');
                cardioBlock.classList.add('hidden');
                
                if (f.db) document.getElementById('hint-dumbbell').classList.add('visible');
                if (f.uni) document.getElementById('hint-unilateral').classList.add('visible');
                if (f.mach) document.getElementById('hint-machine').classList.add('visible');
                if (f.face) document.getElementById('hint-facepull').classList.add('visible');
                if (type === 1 || name === "–ü–ª–∞–Ω–∫–∞") document.getElementById('hint-bodyweight').classList.add('visible'); // –§–∏–∫—Å –¥–ª—è –ü–ª–∞–Ω–∫–∏

                const lW = document.getElementById('label-w');
                const lR = document.getElementById('label-r');
                lW.innerHTML = (type === 2 || type === 1) ? "–î–æ–ø. –≤–µ—Å (–∫–≥)" : "–í–µ—Å (–∫–≥) <span id='pr-display' class='pr-badge'>" + prEl.innerText + "</span>";
                lR.innerText = (type === 2) ? "–í—Ä–µ–º—è (—Å–µ–∫)" : "–ü–æ–≤—Ç–æ—Ä—ã";
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function addSet() {
            const cat = document.getElementById('select-cat').value;
            const exIdx = document.getElementById('select-ex').value;
            const [name, type, mult, flags] = EX_DB[cat][exIdx];
            
            let w = 0, r = 0, kcal = 0, vol = 0, xp = 0;

            if (type === 3) { // –ö–ê–†–î–ò–û –õ–û–ì–ò–ö–ê
                const intensityKey = document.getElementById('input-cardio-intensity').value; // 3, 6, 9...
                const duration = parseFloat(document.getElementById('input-cardio-time').value);
                if (!duration) return tg.showAlert("–£–∫–∞–∂–∏ –≤—Ä–µ–º—è!");
                
                // –ë–µ—Ä–µ–º MET –∏–∑ —Ç–∞–±–ª–∏—Ü—ã, –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ —Ñ–æ–ª–ª–±–µ–∫
                let realMET = parseFloat(intensityKey);
                if (MET_CARDIO[name] && MET_CARDIO[name][intensityKey]) {
                    realMET = MET_CARDIO[name][intensityKey];
                }

                // –§–æ—Ä–º—É–ª–∞: MET * 3.5 * –í–µ—Å / 200 * –ú–∏–Ω—É—Ç—ã
                kcal = (realMET * 3.5 * profile.weight / 200) * duration; 
                xp = Math.round(kcal * 1.5);
                r = duration; 
                vol = duration; 
            
            } else { // –°–ò–õ–û–í–ê–Ø –õ–û–ì–ò–ö–ê
                w = parseFloat(document.getElementById('input-w').value) || 0;
                r = parseFloat(document.getElementById('input-r').value);
                if (!r) return tg.showAlert("–£–∫–∞–∂–∏ –ø–æ–≤—Ç–æ—Ä—ã!");

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ PR (–†–µ–∫–æ—Ä–¥)
                if (w > (personalRecords[name] || 0) && type !== 2) {
                    personalRecords[name] = w;
                    localStorage.setItem('ip_prs', JSON.stringify(personalRecords));
                    showToast(`üèÜ –ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥: ${w} –∫–≥!`);
                    tg.HapticFeedback.notificationOccurred('success');
                }

                // –†–∞—Å—á–µ—Ç –¢–æ–Ω–Ω–∞–∂–∞
                let load = w;
                if (mult === 2) load = w * 2; 
                if (type === 1) load = 0; // –°–≤–æ–π –≤–µ—Å
                vol = (type === 2) ? 0 : (load * r);

                // --- –ù–û–í–ê–Ø –§–ò–ó–ò–ö–ê –ö–ê–õ–û–†–ò–ô (Weight Sensitive) ---
                let estimatedTimeMin = (type === 2) ? (r/60) : (r * 0.1); // –ì—Ä—É–±–æ: 1 –ø–æ–≤—Ç–æ—Ä = 6 —Å–µ–∫ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π + –æ—Ç–¥—ã—Ö
                // –ú–∏–Ω–∏–º—É–º 2 –º–∏–Ω—É—Ç—ã "–º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–≥–æ –∫—Ä–µ–¥–∏—Ç–∞" –Ω–∞ –ø–æ–¥—Ö–æ–¥ (–≤—Ä–µ–º—è —Å–µ—Ç–∞ + –æ—Ç–¥—ã—Ö)
                let metabolicTime = Math.max(estimatedTimeMin, 1.5); 

                let baseMET = 3.5; // –ë–∞–∑–æ–≤—ã–π –æ—Ç–¥—ã—Ö/–ª–µ–≥–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
                
                // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ù–∞–ø—Ä—è–∂–µ–Ω–∏—è: (–í–µ—Å —Å–Ω–∞—Ä—è–¥–∞ / –í–µ—Å —Ç–µ–ª–∞)
                // –ï—Å–ª–∏ —Ç—ã –≤–µ—Å–∏—à—å 80, –∞ —Ç—è–Ω–µ—à—å 180 (–∫–æ—ç—Ñ 2.25) -> MET –≤–∑–ª–µ—Ç–∞–µ—Ç
                let liftWeight = load;
                if (type === 1) liftWeight = 0; // –°–≤–æ–π –≤–µ—Å –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ —á–∏—Å–ª–∏—Ç–µ–ª—å —Ç—É—Ç, —Å—á–∏—Ç–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ
                
                let intensityFactor = liftWeight / profile.weight; 
                
                // –ë–æ–Ω—É—Å –∫ MET –æ—Ç –≤–µ—Å–∞. –¢—è–∂–µ–ª—ã–π –≤–µ—Å (1.5x —Ç–µ–ª–∞) –¥–∞–µ—Ç +6 MET
                let weightMETBonus = intensityFactor * 4.0; 
                
                // –ï—Å–ª–∏ —Å–≤–æ–µ —Ç–µ–ª–æ (–æ—Ç–∂–∏–º–∞–Ω–∏—è)
                if (type === 1) weightMETBonus += 3.0; // –û—Ç–∂–∏–º–∞–Ω–∏—è —ç—Ç–æ —Ç—è–∂–µ–ª–æ
                if (type === 4) weightMETBonus *= 0.7; // –¢—Ä–µ–Ω–∞–∂–µ—Ä—ã –ª–µ–≥—á–µ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –≤–µ—Å–æ–≤

                let totalMET = baseMET + weightMETBonus;
                
                // –û–≥—Ä–∞–Ω–∏—á–∏—Ç–µ–ª—å (—á—Ç–æ–±—ã 18000–∫–≥ –Ω–µ –¥–∞–≤–∞–ª–∏ –º–∏–ª–ª–∏–æ–Ω –∫–∫–∞–ª, –Ω–æ –¥–∞–≤–∞–ª–∏ –º–Ω–æ–≥–æ)
                if (totalMET > 18) totalMET = 18; // –•–∞—Ä–¥ –∫–∞–ø (—Å–ø—Ä–∏–Ω—Ç –≤ –≥–æ—Ä—É)

                kcal = (totalMET * 3.5 * profile.weight / 200) * metabolicTime;

                // XP: –£—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–¥–Ω—è—Ç—ã–π –≤–µ—Å —Å–∏–ª—å–Ω–µ–µ
                let liftXP = (vol / 20) + (w * 0.5); 
                if (type === 1) liftXP = r * 2; // XP –∑–∞ —Å–≤–æ–π –≤–µ—Å
                xp = Math.round(liftXP + kcal);
            }

            currentSession.unshift({ id: Date.now(), name, vol, kcal: Math.round(kcal), xp, w, r, type });
            saveSession();
            tg.HapticFeedback.impactOccurred('medium');
            renderMain();
            adaptInputs(); // –û–±–Ω–æ–≤–∏—Ç—å –±–µ–π–¥–∂ —Ä–µ–∫–æ—Ä–¥–∞
            
            lastExName = name;
            if (type !== 3) {
                document.getElementById('input-r').value = ''; 
            }
        }

        function finishWorkout() {
            if (currentSession.length === 0) return;

            const vol = currentSession.reduce((a, c) => a + c.vol, 0);
            const kcal = currentSession.reduce((a, c) => a + c.kcal, 0);
            let xp = currentSession.reduce((a, c) => a + c.xp, 0);
            if (xp > 15000) xp = 15000; // Soft cap

            // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞
            let cardioMins = 0;
            let strengthSets = 0;
            currentSession.forEach(s => {
                if (s.type === 3) cardioMins += s.r;
                else strengthSets++;
            });
            let strengthMins = strengthSets * 3; 
            let totalTime = Math.round(cardioMins + strengthMins);
            let sessionType = (cardioMins > strengthMins * 2) ? 'cardio' : 'strength';

            // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ü–û–°–õ–ï–î–ù–ï–ô —Ç–∞–∫–æ–π –∂–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–æ–π
            let diffPercent = 0;
            let diffType = 'neutral';
            
            if (history.length > 0) {
                // –ò—â–µ–º –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å (—Å–∞–º—É—é –Ω–æ–≤—É—é) —Ç–∞–∫–æ–≥–æ –∂–µ —Ç–∏–ø–∞
                const prev = history.find(h => (h.type || 'strength') === sessionType);
                
                if (prev) {
                    let currVal = (sessionType === 'cardio') ? xp : vol;
                    let prevVal = (sessionType === 'cardio') ? prev.xp : prev.vol;
                    
                    if (prevVal > 0) {
                        diffPercent = ((currVal - prevVal) / prevVal) * 100;
                        if (diffPercent > 3) diffType = 'pos';
                        if (diffPercent < -3) diffType = 'neg';
                    }
                }
            }

            const record = {
                date: Date.now(),
                dateStr: new Date().toLocaleDateString('ru-RU', {day:'numeric', month:'short'}),
                vol, kcal, xp, time: totalTime, type: sessionType
            };
            
            history.unshift(record);
            totalXP += xp;
            
            localStorage.setItem('ip_history', JSON.stringify(history));
            localStorage.setItem('ip_xp', totalXP);
            localStorage.removeItem('ip_current');
            currentSession = [];

            // UI –†–µ–∑—É–ª—å—Ç–∞—Ç
            document.getElementById('res-xp').innerText = `+${Math.round(xp)} XP`;
            document.getElementById('res-vol').innerText = (sessionType === 'cardio') ? "–ö–∞—Ä–¥–∏–æ" : vol + " –∫–≥";
            document.getElementById('res-kcal').innerText = Math.round(kcal);
            document.getElementById('res-time').innerText = totalTime;
            
            const tipsArr = TIPS[profile.goal] || TIPS['health'];
            document.getElementById('res-tip').innerHTML = "üí° " + tipsArr[Math.floor(Math.random() * tipsArr.length)];

            const badge = document.getElementById('res-diff-badge');
            if (diffType !== 'neutral') {
                badge.classList.remove('hidden', 'diff-pos', 'diff-neg');
                badge.classList.add(diffType === 'pos' ? 'diff-pos' : 'diff-neg');
                badge.innerText = (diffType === 'pos' ? '‚ñ≤' : '‚ñº') + ` ${Math.abs(diffPercent).toFixed(1)}%`;
            } else {
                badge.classList.add('hidden');
            }

            document.getElementById('res-msg').innerText = diffType === 'neg' 
                ? "–õ–µ–≥–∫–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ‚Äî —Ç–æ–∂–µ —á–∞—Å—Ç—å –ø–ª–∞–Ω–∞." 
                : "–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –î–≤–∏–≥–∞–µ–º—Å—è –¥–∞–ª—å—à–µ.";

            showScreen('screen-result');
            tg.HapticFeedback.notificationOccurred('success');
            renderMain();
        }

        // --- –£–¢–ò–õ–ò–¢–´ ---
        function deleteSet(id) {
            currentSession = currentSession.filter(s => s.id !== id);
            saveSession();
            renderMain();
        }
        
        function deleteHistoryItem(index) {
            if(confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∏ –ø–æ—Ç–µ—Ä—è—Ç—å XP?")) {
                const item = history[index];
                if (item.xp) totalXP = Math.max(0, totalXP - item.xp);
                history.splice(index, 1);
                localStorage.setItem('ip_history', JSON.stringify(history));
                localStorage.setItem('ip_xp', totalXP);
                renderMain();
            }
        }

        function saveSession() { localStorage.setItem('ip_current', JSON.stringify(currentSession)); }
        function saveProfile() {
            const w = parseFloat(document.getElementById('prof-weight').value);
            const h = parseFloat(document.getElementById('prof-height').value);
            const a = parseFloat(document.getElementById('prof-age').value);
            if (!w || !h || !a) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!");
            profile = { weight: w, height: h, age: a, gender: document.getElementById('prof-gender').value, goal: document.getElementById('prof-goal').value };
            localStorage.setItem('ip_profile', JSON.stringify(profile));
            showScreen('screen-main'); updateExList(); renderMain();
        }

        function renderMain() {
            document.getElementById('stat-xp').innerText = Math.round(totalXP).toLocaleString();
            document.getElementById('stat-count').innerText = history.length;
            updateCharacter();

            const curBlock = document.getElementById('current-session-block');
            if (currentSession.length > 0) {
                curBlock.classList.remove('hidden');
                let curXP = currentSession.reduce((a,c)=>a+c.xp,0);
                document.getElementById('session-title').innerText = `–°–µ–π—á–∞—Å: +${Math.round(curXP)} XP`;
                document.getElementById('current-list').innerHTML = currentSession.map(s => `
                    <div class="list-item">
                        <div><b>${s.name}</b><div style="font-size:12px; opacity:0.7">${s.type===3?s.r+' –º–∏–Ω':(s.type===2?s.r+' —Å–µ–∫':(s.w>0?s.w+'–∫–≥ √ó ':'')+s.r)}</div></div>
                        <div style="text-align:right">
                            <span style="color:var(--gold); font-weight:bold">+${s.xp}</span><br><span style="font-size:10px; opacity:0.5">${s.kcal} –∫–∫–∞–ª</span>
                            <span class="del-btn" onclick="deleteSet(${s.id})">‚úï</span>
                        </div>
                    </div>`).join('');
            } else { curBlock.classList.add('hidden'); }

            document.getElementById('history-list').innerHTML = history.map((h, i) => {
                let desc = '', emoji = 'üèãÔ∏è';
                if (h.type === 'cardio') { desc = `${h.time} –º–∏–Ω`; emoji = 'üèÉ'; }
                else { desc = `${h.vol} –∫–≥`; }
                return `
                <div class="list-item">
                    <div style="opacity:0.8"><div>${h.dateStr}</div><div style="font-size:10px; color:var(--tg-hint)">${emoji} ${(h.type||'strength').toUpperCase()}</div></div>
                    <div style="text-align:right; display:flex; align-items:center">
                        <div style="margin-right:10px">${desc} <span style="color:var(--gold)">+${Math.round(h.xp)}</span></div>
                        <div class="del-btn" onclick="deleteHistoryItem(${i})">‚úï</div>
                    </div>
                </div>`
            }).join('') || '<div style="text-align:center; opacity:0.5; padding:20px">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–∞—á–Ω–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É!</div>';
        }

        function updateCharacter() {
            let current = LEVELS[0], next = LEVELS[1];
            for (let i = 0; i < LEVELS.length; i++) {
                if (totalXP >= LEVELS[i].xp) { current = LEVELS[i]; next = LEVELS[i+1] || { xp: totalXP*10, rank: "–ú–∞–∫—Å–∏–º—É–º" }; }
            }
            document.getElementById('main-char-icon').innerText = current.icon;
            document.getElementById('main-char-rank').innerText = current.rank;
            document.getElementById('stat-lvl').innerText = LEVELS.indexOf(current) + 1;
            document.getElementById('main-char-xp').innerText = `${Math.round(totalXP)} XP`;
            document.getElementById('main-char-next').innerText = `–¶–µ–ª—å: ${next.xp}`;
            document.getElementById('xp-fill').style.width = Math.min(100, ((totalXP - current.xp)/(next.xp - current.xp))*100) + "%";
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById(id).classList.add('active-screen');
            window.scrollTo(0,0);
        }
        function closeResult() { showScreen('screen-main'); }
        function safeReset() {
            if (confirm("–£–¥–∞–ª–∏—Ç—å –∞–±—Å–æ–ª—é—Ç–Ω–æ –≤—Å—ë? –≠—Ç–æ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.")) { localStorage.clear(); location.reload(); }
        }
    </script>
</body>
</html>