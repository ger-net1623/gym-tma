<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IronPath - –¢–≤–æ–π —Å–∏–ª–æ–≤–æ–π –ø—É—Ç—å</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { 
            --main-blue: #3390ec; 
            --bg: #1a1a1a; 
            --card-bg: #2b2b2b;
            --text-gray: #aaaaaa;
            --green: #4ade80;
            --red: #ef4444;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            color: #fff; 
            margin: 0; padding: 16px;
            max-width: 600px; margin: 0 auto; 
            -webkit-tap-highlight-color: transparent;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–æ–≤ */
        .screen { display: none; animation: fadeIn 0.3s ease-out; }
        .active-screen { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* UI –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã */
        .card { 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: 20px; 
            margin-bottom: 16px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        h1, h2, h3 { margin: 0 0 10px 0; font-weight: 800; }
        p { color: var(--text-gray); font-size: 15px; line-height: 1.5; margin-bottom: 20px; }

        .btn { 
            width: 100%; padding: 16px; border: none; border-radius: 14px; 
            font-size: 16px; font-weight: 700; cursor: pointer; transition: transform 0.1s;
            display: flex; align-items: center; justify-content: center;
        }
        .btn:active { transform: scale(0.97); opacity: 0.9; }
        .btn-primary { background: var(--main-blue); color: #fff; }
        .btn-success { background: var(--green); color: #000; }
        .btn-outline { background: transparent; border: 1px solid #444; color: var(--text-gray); margin-top: 15px; font-size: 13px; padding: 10px;}

        input, select { 
            width: 100%; padding: 14px; margin-bottom: 12px; 
            background: #1f1f1f; border: 1px solid #333; border-radius: 12px; 
            color: #fff; font-size: 16px; box-sizing: border-box;
            transition: border-color 0.2s;
        }
        input:focus, select:focus { border-color: var(--main-blue); outline: none; }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; text-align: center; }
        .stat-val { font-size: 20px; font-weight: 800; color: var(--main-blue); }
        .stat-label { font-size: 11px; text-transform: uppercase; color: var(--text-gray); margin-top: 4px; }

        /* –ü–µ—Ä—Å–æ–Ω–∞–∂ */
        .char-container { text-align: center; padding: 10px 0 20px 0; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 15px; }
        .char-icon { font-size: 72px; display: block; margin-bottom: 5px; animation: pulse 3s infinite; }
        .char-rank { font-size: 18px; font-weight: bold; color: #fff; }
        .char-next { font-size: 12px; color: var(--text-gray); margin-top: 4px; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* –°–ø–∏—Å–∫–∏ */
        .list-item { 
            padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); 
            display: flex; justify-content: space-between; align-items: center;
        }
        .list-item:last-child { border-bottom: none; }
        .del-btn { color: var(--red); padding: 5px 10px; cursor: pointer; font-size: 18px; opacity: 0.7; }
        
        /* –†–µ–∑—É–ª—å—Ç–∞—Ç */
        .result-big { font-size: 42px; font-weight: 900; margin: 15px 0; line-height: 1; }
        .green-text { color: var(--green); }
        .red-text { color: var(--red); }
        .diff-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; background: rgba(255,255,255,0.1); font-weight: bold; font-size: 14px; margin-top: 5px;}
        
        /* –û–Ω–±–æ—Ä–¥–∏–Ω–≥ */
        .dots { display: flex; justify-content: center; gap: 8px; margin-bottom: 25px; }
        .dot { width: 8px; height: 8px; background: #444; border-radius: 50%; transition: background 0.3s; }
        .dot.active { background: var(--main-blue); transform: scale(1.2); }
        .ob-slide { min-height: 280px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="screen-onboarding" class="screen">
        <div class="card" style="min-height: 450px; display: flex; flex-direction: column; justify-content: space-between;">
            <div>
                <div class="dots" id="dots-container">
                    <div class="dot active"></div><div class="dot"></div><div class="dot"></div>
                </div>
                <div class="ob-slide">
                    <div style="font-size: 70px; margin-bottom: 20px;" id="ob-icon">üí™</div>
                    <h2 id="ob-title">–§–∏–∫—Å–∏—Ä—É–π –ø—Ä–æ–≥—Ä–µ—Å—Å</h2>
                    <p id="ob-text">–ó–∞–ø–∏—Å—ã–≤–∞–π –≤–µ—Å–∞ –∏ –ø–æ–≤—Ç–æ—Ä—ã. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–∞–º–æ –ø–æ—Å—á–∏—Ç–∞–µ—Ç –æ–±—ä–µ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ –ø–æ–∫–∞–∂–µ—Ç —Ç–≤–æ–π —Ä–æ—Å—Ç.</p>
                </div>
            </div>
            <button class="btn btn-primary" onclick="nextOnboardingStep()">–î–∞–ª–µ–µ</button>
        </div>
    </div>

    <div id="screen-profile" class="screen">
        <div class="card">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è</h2>
            <p>–≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –Ω—É–∂–Ω—ã –¥–ª—è —Ç–æ—á–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª —Ä–∞—Å—Ö–æ–¥–∞ –∫–∞–ª–æ—Ä–∏–π (MET) –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.</p>
            
            <label style="font-size:12px; color:#777; margin-left: 4px;">–¢–≤–æ–π –≤–µ—Å (–∫–≥)</label>
            <input type="number" id="prof-weight" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 75" inputmode="decimal">
            
            <label style="font-size:12px; color:#777; margin-left: 4px;">–ü–æ–ª</label>
            <select id="prof-gender">
                <option value="male">–ú—É–∂—á–∏–Ω–∞</option>
                <option value="female">–ñ–µ–Ω—â–∏–Ω–∞</option>
            </select>

            <label style="font-size:12px; color:#777; margin-left: 4px;">–¶–µ–ª—å</label>
            <select id="prof-goal">
                <option value="1.2">–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã</option>
                <option value="1.5">–°–∏–ª–∞ –∏ –ú–∞—Å—Å–∞</option>
                <option value="1.0">–ü–æ—Ö—É–¥–µ–Ω–∏–µ / –†–µ–ª—å–µ—Ñ</option>
            </select>

            <button class="btn btn-primary" style="margin-top: 10px;" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –Ω–∞—á–∞—Ç—å</button>
        </div>
    </div>

    <div id="screen-main" class="screen">
        <div class="card">
            <div class="char-container">
                <span class="char-icon" id="main-char-icon">üê£</span>
                <div class="char-rank" id="main-char-rank">–ù–æ–≤–∏—á–æ–∫</div>
                <div class="char-next" id="main-char-next">–¥–æ —Å–ª–µ–¥. —É—Ä–æ–≤–Ω—è: 3 —Ç—Ä–µ–Ω—ã</div>
            </div>
            <div class="stat-grid">
                <div><div class="stat-val" id="stat-vol">0</div><div class="stat-label">–¢–æ–Ω–Ω–∞–∂ (—Ç)</div></div>
                <div><div class="stat-val" id="stat-kcal">0</div><div class="stat-label">–ö–∫–∞–ª</div></div>
                <div><div class="stat-val" id="stat-count">0</div><div class="stat-label">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div></div>
            </div>
        </div>

        <div class="card">
            <h3>–ó–∞–ø–∏—Å—å –ø–æ–¥—Ö–æ–¥–∞</h3>
            <select id="input-ex">
                <option value="6.0">–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è</option>
                <option value="5.5">–ñ–∏–º –ª–µ–∂–∞</option>
                <option value="6.0">–°—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞</option>
                <option value="4.0">–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è</option>
                <option value="3.5">–ñ–∏–º –ø–ª–µ—á–∞–º–∏</option>
                <option value="3.0">–ë–∏—Ü–µ–ø—Å / –¢—Ä–∏—Ü–µ–ø—Å</option>
                <option value="3.5">–ü—Ä–µ—Å—Å / –ö–æ—Ä</option>
                <option value="5.0">–¢—è–≥–∞ –≤ –Ω–∞–∫–ª–æ–Ω–µ</option>
                <option value="4.5">–í—ã–ø–∞–¥—ã</option>
                <option value="4.0">–ö–∞—Ä–¥–∏–æ / –ë–µ–≥</option>
            </select>
            <div style="display: flex; gap: 10px;">
                <input type="number" id="input-w" placeholder="–í–µ—Å (–∫–≥)" inputmode="decimal">
                <input type="number" id="input-r" placeholder="–ü–æ–≤—Ç–æ—Ä—ã" inputmode="numeric">
            </div>
            <button class="btn btn-primary" onclick="addSet()">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥</button>
        </div>

        <div id="current-session-block" class="card hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; font-size:16px;">–¢–µ–∫—É—â–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h3>
                <span id="session-total" style="font-size:12px; color:var(--main-blue); font-weight:bold">0 –∫–≥</span>
            </div>
            <div id="current-list"></div>
            <button class="btn btn-success" style="margin-top: 15px;" onclick="finishWorkout()">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
        </div>

        <div class="card">
            <h3 style="font-size: 16px; opacity: 0.8;">–ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
            <div id="history-list"></div>
            <button class="btn btn-outline" onclick="safeReset()">–°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö</button>
        </div>
    </div>

    <div id="screen-result" class="screen" style="text-align: center;">
        <div class="card">
            <div style="font-size: 60px; margin-bottom: 10px;">üî•</div>
            <h2>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2>
            <p id="res-quote" style="font-style: italic; margin-bottom: 25px; font-size: 14px;">"–¶–∏—Ç–∞—Ç–∞"</p>
            
            <div style="background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; margin: 20px 0;">
                <div style="font-size: 13px; opacity: 0.7; text-transform: uppercase;">–û–±—ä–µ–º –∑–∞ —Å–µ–≥–æ–¥–Ω—è</div>
                <div class="result-big" id="res-vol">0</div>
                <div id="res-diff" class="diff-badge">+0%</div>
            </div>

            <div class="stat-grid" style="margin-top: 30px;">
                <div><div class="stat-val" id="res-kcal">0</div><div class="stat-label">–ö–∫–∞–ª</div></div>
                <div><div class="stat-val" id="res-sets">0</div><div class="stat-label">–ü–æ–¥—Ö–æ–¥–æ–≤</div></div>
                <div><div class="stat-val" id="res-ex">0</div><div class="stat-label">–£–ø—Ä.</div></div>
            </div>

            <button class="btn btn-primary" style="margin-top: 30px;" onclick="closeResult()">–ö—Ä—É—Ç–æ!</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let profile = JSON.parse(localStorage.getItem('ip_profile'));
        let history = JSON.parse(localStorage.getItem('ip_history')) || [];
        let currentSession = JSON.parse(localStorage.getItem('ip_current')) || [];

        init();

        function init() {
            if (!profile) {
                showScreen('screen-onboarding');
            } else {
                showScreen('screen-main');
                renderMain();
            }
        }

        // --- –û–ù–ë–û–†–î–ò–ù–ì ---
        let obStep = 0;
        const obData = [
            { icon: "üí™", title: "–§–∏–∫—Å–∏—Ä—É–π –ø—Ä–æ–≥—Ä–µ—Å—Å", text: "–ù–∏–∫–∞–∫–∏—Ö –±–ª–æ–∫–Ω–æ—Ç–æ–≤. –í–±–∏–≤–∞–π –≤–µ—Å –∏ –ø–æ–≤—Ç–æ—Ä—ã. –ú—ã —Å–æ—Ö—Ä–∞–Ω–∏–º –∏ –ø–æ—Å—á–∏—Ç–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–µ." },
            { icon: "üìä", title: "–£–º–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞", text: "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–≤–æ–π –ø–æ–ª –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π (MET) –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∫–∞–ª–æ—Ä–∏–π." },
            { icon: "üê≤", title: "RPG –°–∏—Å—Ç–µ–º–∞", text: "–ü—Ä–æ–∫–∞—á–∏–≤–∞–π—Å—è –≤ –∑–∞–ª–µ –∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏. –†–∞—Å—Ç–∏ –æ—Ç –¶—ã–ø–ª–µ–Ω–∫–∞ –¥–æ –¢–∏—Ç–∞–Ω–∞!" }
        ];

        function nextOnboardingStep() {
            obStep++;
            if (obStep < 3) {
                const slide = document.querySelector('.ob-slide');
                slide.style.opacity = 0;
                setTimeout(() => {
                    document.getElementById('ob-icon').innerText = obData[obStep].icon;
                    document.getElementById('ob-title').innerText = obData[obStep].title;
                    document.getElementById('ob-text').innerText = obData[obStep].text;
                    slide.style.opacity = 1;
                }, 200);

                const dots = document.querySelectorAll('.dot');
                dots.forEach(d => d.classList.remove('active'));
                dots[obStep].classList.add('active');
            } else {
                showScreen('screen-profile');
            }
        }

        // --- –ü–†–û–§–ò–õ–¨ ---
        function saveProfile() {
            const w = parseFloat(document.getElementById('prof-weight').value);
            if (!w || w < 30 || w > 300) {
                return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–µ—Å (30-300 –∫–≥)");
            }
            
            profile = {
                weight: w,
                gender: document.getElementById('prof-gender').value,
                goal: parseFloat(document.getElementById('prof-goal').value),
                startDate: new Date().toLocaleDateString()
            };
            localStorage.setItem('ip_profile', JSON.stringify(profile));
            showScreen('screen-main');
            renderMain();
        }

        // --- –¢–†–ï–ù–ò–†–û–í–ö–ê ---
        function addSet() {
            const exSelect = document.getElementById('input-ex');
            const name = exSelect.options[exSelect.selectedIndex].text;
            const met = parseFloat(exSelect.value);
            const wInput = document.getElementById('input-w');
            const rInput = document.getElementById('input-r');
            
            const w = parseFloat(wInput.value);
            const r = parseFloat(rInput.value);

            if (!w || !r || w <= 0 || r <= 0) {
                tg.HapticFeedback.notificationOccurred('error');
                return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–µ—Å –∏ –ø–æ–≤—Ç–æ—Ä—ã");
            }

            // –§–æ—Ä–º—É–ª–∞: MET * –í–µ—Å * 0.05 —á–∞—Å–∞ * –ì–µ–Ω–¥–µ—Ä. (Goal —É–±—Ä–∞–Ω –∏–∑ —Ñ–æ—Ä–º—É–ª—ã —Ä–∞—Å—Ö–æ–¥–∞)
            const genderMod = profile.gender === 'female' ? 0.9 : 1.0;
            const kcal = Math.round(met * profile.weight * 0.05 * genderMod); 

            const set = {
                id: Date.now(),
                name: name,
                w: w, r: r,
                vol: w * r,
                kcal: kcal
            };

            currentSession.unshift(set);
            localStorage.setItem('ip_current', JSON.stringify(currentSession));
            
            rInput.value = ''; // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–≤—Ç–æ—Ä—ã
            rInput.focus();
            
            tg.HapticFeedback.impactOccurred('medium');
            renderMain();
        }

        function deleteSet(id) {
            if(!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥?")) return;
            currentSession = currentSession.filter(s => s.id !== id);
            localStorage.setItem('ip_current', JSON.stringify(currentSession));
            renderMain();
        }

        function renderMain() {
            // –ì–ª–∞–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ = –¢–û–õ–¨–ö–û –ò–°–¢–û–†–ò–Ø (–±–µ–∑ —Ç–µ–∫—É—â–µ–π)
            const histVol = history.reduce((acc, h) => acc + h.totalVol, 0);
            const histKcal = history.reduce((acc, h) => acc + h.totalKcal, 0);

            document.getElementById('stat-vol').innerText = (histVol / 1000).toFixed(1);
            document.getElementById('stat-kcal').innerText = histKcal.toLocaleString();
            document.getElementById('stat-count').innerText = history.length;

            updateCharacter(history.length);

            // –¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è
            const curDiv = document.getElementById('current-session-block');
            const curList = document.getElementById('current-list');
            
            if (currentSession.length > 0) {
                curDiv.classList.remove('hidden');
                const currVol = currentSession.reduce((acc, s) => acc + s.vol, 0);
                document.getElementById('session-total').innerText = "–ò—Ç–æ–≥–æ —Å–µ–π—á–∞—Å: " + currVol + " –∫–≥";
                
                curList.innerHTML = currentSession.map(s => `
                    <div class="list-item">
                        <div>
                            <div style="font-weight:600; font-size:15px;">${s.name}</div>
                            <div style="opacity:0.6; font-size:13px;">${s.w} –∫–≥ √ó ${s.r} –ø–æ–≤—Ç</div>
                        </div>
                        <div style="display:flex; align-items:center;">
                            <span style="color:var(--main-blue); font-weight:bold; margin-right:15px;">${s.vol} –∫–≥</span>
                            <span class="del-btn" onclick="deleteSet(${s.id})">‚úï</span>
                        </div>
                    </div>
                `).join('');
            } else {
                curDiv.classList.add('hidden');
            }

            // –ò—Å—Ç–æ—Ä–∏—è (–¢–æ–ø 3)
            const histList = document.getElementById('history-list');
            if (history.length === 0) {
                histList.innerHTML = '<p style="text-align:center; opacity:0.5; margin-top:10px;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞. –ù–∞—á–Ω–∏ –ø—É—Ç—å —Å–µ–≥–æ–¥–Ω—è!</p>';
            } else {
                histList.innerHTML = history.slice(0, 3).map(h => `
                    <div class="list-item">
                        <div>
                            <div style="font-weight:bold; color:#fff">${h.date}</div>
                            <div style="font-size:12px; opacity:0.6">${h.setsCount} –ø–æ–¥—Ö–æ–¥–∞ ‚Ä¢ ${h.totalKcal} –∫–∫–∞–ª</div>
                        </div>
                        <div style="color:var(--green); font-weight:bold">+ ${(h.totalVol/1000).toFixed(1)} —Ç</div>
                    </div>
                `).join('');
            }
        }

        function updateCharacter(lvl) {
            let char = "üê£", rank = "–ù–æ–≤–∏—á–æ–∫", next = 3;
            if (lvl >= 50) { char = "üëë"; rank = "–õ–µ–≥–µ–Ω–¥–∞"; next = 1000; }
            else if (lvl >= 30) { char = "üêâ"; rank = "–¢–∏—Ç–∞–Ω"; next = 50; }
            else if (lvl >= 20) { char = "ü¶ñ"; rank = "–ú–æ–Ω—Å—Ç—Ä"; next = 30; }
            else if (lvl >= 12) { char = "ü¶ç"; rank = "–ó–≤–µ—Ä—å"; next = 20; }
            else if (lvl >= 6) { char = "üêì"; rank = "–ê—Ç–ª–µ—Ç"; next = 12; }
            else if (lvl >= 3) { char = "üê•"; rank = "–õ—é–±–∏—Ç–µ–ª—å"; next = 6; }

            document.getElementById('main-char-icon').innerText = char;
            document.getElementById('main-char-rank').innerText = rank;
            
            if (next === 1000) {
                document.getElementById('main-char-next').innerText = "–ú–∞–∫—Å–∏–º—É–º!";
            } else {
                document.getElementById('main-char-next').innerText = `–¥–æ —Å–ª–µ–¥. —É—Ä–æ–≤–Ω—è: ${next - lvl} —Ç—Ä–µ–Ω`;
            }
        }

        // --- –ó–ê–í–ï–†–®–ï–ù–ò–ï ---
        function finishWorkout() {
            if (currentSession.length === 0) {
                return tg.showAlert("–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–æ–¥—Ö–æ–¥!");
            }

            const vol = currentSession.reduce((a,c) => a + c.vol, 0);
            const kcal = currentSession.reduce((a,c) => a + c.kcal, 0);
            const setsCount = currentSession.length;
            const uniqueEx = new Set(currentSession.map(s => s.name)).size;

            // –†–∞—Å—á–µ—Ç % –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            let diffText = "–û—Ç–ª–∏—á–Ω–æ–µ –Ω–∞—á–∞–ª–æ!";
            let diffClass = "green-text";
            
            if (history.length > 0) {
                const prevVol = history[0].totalVol;
                if (prevVol > 0) {
                    const diff = Math.round(((vol - prevVol) / prevVol) * 100);
                    if (diff > 0) {
                        diffText = `+${diff}% –∫ –ø—Ä–æ—à–ª–æ–π`;
                    } else if (diff === 0) {
                        diffText = "–°—Ç–∞–±–∏–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç";
                        diffClass = "";
                    } else {
                        diffText = `${diff}% (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ)`;
                        diffClass = "red-text";
                    }
                }
            }

            document.getElementById('res-vol').innerText = vol.toLocaleString() + " –∫–≥";
            const diffEl = document.getElementById('res-diff');
            diffEl.innerText = diffText;
            diffEl.className = "diff-badge " + diffClass;
            
            document.getElementById('res-kcal').innerText = kcal;
            document.getElementById('res-sets').innerText = setsCount;
            document.getElementById('res-ex').innerText = uniqueEx;

            const quotes = [
                "–ë–æ–ª—å –≤—Ä–µ–º–µ–Ω–Ω–∞. –¢—Ä–∏—É–º—Ñ –≤–µ—á–µ–Ω.",
                "–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ ‚Äî —ç—Ç–æ –¥–µ–ª–∞—Ç—å —Ç–æ, —á—Ç–æ –Ω–µ —Ö–æ—á–µ—Ç—Å—è, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ç–æ, —á—Ç–æ —Ö–æ—á–µ—Ç—Å—è.",
                "–¢–≤–æ—ë —Ç–µ–ª–æ –º–æ–∂–µ—Ç –≤—Å—ë. –£–±–µ–¥–∏ –≤ —ç—Ç–æ–º –º–æ–∑–≥.",
                "–ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Å—è, –∫–æ–≥–¥–∞ —É—Å—Ç–∞–ª. –û—Å—Ç–∞–Ω–æ–≤–∏—Å—å, –∫–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏–ª."
            ];
            document.getElementById('res-quote').innerText = quotes[Math.floor(Math.random() * quotes.length)];

            const record = {
                id: Date.now(),
                date: new Date().toLocaleDateString('ru-RU', {day:'numeric', month:'short'}),
                totalVol: vol,
                totalKcal: kcal,
                setsCount: setsCount
            };
            
            history.unshift(record);
            localStorage.setItem('ip_history', JSON.stringify(history));
            
            currentSession = [];
            localStorage.removeItem('ip_current');

            showScreen('screen-result');
            tg.HapticFeedback.notificationOccurred('success');
        }

        function closeResult() {
            showScreen('screen-main');
            renderMain(); // –í–∞–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É!
        }

        // --- –£–¢–ò–õ–ò–¢–´ ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById(id).classList.add('active-screen');
            window.scrollTo(0,0);
        }

        function safeReset() {
            if (confirm("–¢–æ—á–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.")) {
                localStorage.removeItem('ip_profile');
                localStorage.removeItem('ip_history');
                localStorage.removeItem('ip_current');
                location.reload();
            }
        }
    </script>
</body>
</html>