<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IronPath - RPG Tracker</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { 
            --tg-bg: var(--tg-theme-bg-color, #1a1a1a);
            --tg-text: var(--tg-theme-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #aaaaaa);
            --tg-link: var(--tg-theme-link-color, #3390ec);
            --tg-btn: var(--tg-theme-button-color, #3390ec);
            --tg-btn-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary: var(--tg-theme-secondary-bg-color, #2b2b2b);
            
            --green: #4ade80;
            --red: #ef4444;
            --gold: #fbbf24;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--tg-bg); 
            color: var(--tg-text); 
            margin: 0; padding: 16px;
            max-width: 600px; margin: 0 auto; 
            -webkit-tap-highlight-color: transparent;
        }

        .screen { display: none; animation: fadeIn 0.3s ease-out; }
        .active-screen { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .card { 
            background: var(--tg-secondary); 
            padding: 20px; 
            border-radius: 20px; 
            margin-bottom: 16px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        h1, h2, h3 { margin: 0 0 10px 0; font-weight: 800; }
        p { color: var(--tg-hint); font-size: 14px; line-height: 1.4; margin-bottom: 15px; }

        .btn { 
            width: 100%; padding: 16px; border: none; border-radius: 14px; 
            font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-primary { background: var(--tg-btn); color: var(--tg-btn-text); }
        .btn-success { background: var(--green); color: #000; }
        .btn-outline { background: transparent; border: 1px solid var(--tg-hint); color: var(--tg-hint); font-size: 13px; margin-top: 10px; padding: 10px; }
        .btn:active { transform: scale(0.98); opacity: 0.8; }

        input, select { 
            width: 100%; padding: 14px; margin-bottom: 12px; 
            background: var(--tg-bg); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; 
            color: var(--tg-text); font-size: 16px; box-sizing: border-box;
            outline: none;
        }
        input:focus { border-color: var(--tg-link); }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; text-align: center; }
        .stat-val { font-size: 20px; font-weight: 800; color: var(--tg-link); }
        .stat-label { font-size: 10px; text-transform: uppercase; color: var(--tg-hint); margin-top: 4px; }

        /* –ü–µ—Ä—Å–æ–Ω–∞–∂ –∏ XP */
        .char-container { text-align: center; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 15px; }
        .char-icon { font-size: 64px; display: block; margin-bottom: 5px; animation: pulse 3s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        .xp-bar-bg { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-top: 8px; overflow: hidden; position: relative; }
        .xp-bar-fill { height: 100%; background: linear-gradient(90deg, var(--tg-link), #8b5cf6); width: 0%; transition: width 0.5s; }

        .list-item { 
            padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); 
            display: flex; justify-content: space-between; align-items: center;
        }
        .del-btn { color: var(--red); padding: 5px; font-size: 18px; cursor: pointer; }

        .diff-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-top: 5px; background: rgba(255,255,255,0.1);}
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="screen-onboarding" class="screen">
        <div class="card" style="text-align: center; padding-top: 40px; min-height: 300px; display: flex; flex-direction: column; justify-content: space-between;">
            <div>
                <div style="font-size: 60px; margin-bottom: 20px;">‚öîÔ∏è</div>
                <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
                <p>IronPath ‚Äî —ç—Ç–æ RPG, –≥–¥–µ —Ç—ã –ø—Ä–æ–∫–∞—á–∏–≤–∞–µ—à—å —Å–µ–±—è.</p>
                <p>–¢—Ä–µ–Ω–∏—Ä—É–π—Å—è, –ø–æ–ª—É—á–∞–π XP, –ø–æ–≤—ã—à–∞–π —Ä–∞–Ω–≥–∏ –æ—Ç "–ü—Ç–µ–Ω—Ü–∞" –¥–æ "–ö–æ—Ä–æ–ª—è".</p>
            </div>
            <button class="btn btn-primary" onclick="showScreen('screen-profile')">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
        </div>
    </div>

    <div id="screen-profile" class="screen">
        <div class="card">
            <h2>–î–∞–Ω–Ω—ã–µ –±–æ–π—Ü–∞</h2>
            <p>–ù—É–∂–Ω—ã –¥–ª—è —á–µ—Å—Ç–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ XP –∏ –∫–∞–ª–æ—Ä–∏–π.</p>
            <label style="font-size:12px; color:var(--tg-hint)">–¢–≤–æ–π –≤–µ—Å (–∫–≥)</label>
            <input type="number" id="prof-weight" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 80" inputmode="decimal">
            <label style="font-size:12px; color:var(--tg-hint)">–ü–æ–ª</label>
            <select id="prof-gender">
                <option value="male">–ú—É–∂—á–∏–Ω–∞</option>
                <option value="female">–ñ–µ–Ω—â–∏–Ω–∞</option>
            </select>
            <button class="btn btn-primary" onclick="saveProfile()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
        </div>
    </div>

    <div id="screen-main" class="screen">
        <div class="card">
            <div class="char-container">
                <span class="char-icon" id="main-char-icon">üê£</span>
                <div style="font-weight: bold; font-size: 18px;" id="main-char-rank">–ù–æ–≤–∏—á–æ–∫</div>
                <div class="xp-bar-bg"><div class="xp-bar-fill" id="xp-fill"></div></div>
                <div style="display:flex; justify-content:space-between; font-size: 11px; color: var(--tg-hint); margin-top: 5px;">
                    <span id="main-char-xp">0 XP</span>
                    <span id="main-char-next">–¶–µ–ª—å: 100</span>
                </div>
            </div>
            <div class="stat-grid">
                <div><div class="stat-val" id="stat-xp">0</div><div class="stat-label">–í—Å–µ–≥–æ XP</div></div>
                <div><div class="stat-val" id="stat-count">0</div><div class="stat-label">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div></div>
                <div><div class="stat-val" id="stat-lvl">1</div><div class="stat-label">–£—Ä–æ–≤–µ–Ω—å</div></div>
            </div>
        </div>

        <div class="card">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
            <select id="select-cat" onchange="updateExList()">
                <option value="chest">–ì—Ä—É–¥—å</option>
                <option value="back">–°–ø–∏–Ω–∞</option>
                <option value="legs">–ù–æ–≥–∏</option>
                <option value="shoulders">–ü–ª–µ—á–∏</option>
                <option value="arms">–†—É–∫–∏</option>
                <option value="abs">–ü—Ä–µ—Å—Å / –ö–æ—Ä</option>
                <option value="cardio">–ö–∞—Ä–¥–∏–æ</option>
            </select>
            <select id="select-ex" onchange="adaptInputs()"></select>
            
            <div style="display: flex; gap: 10px;">
                <div style="flex:1">
                    <label id="label-w" style="font-size:11px; color:var(--tg-hint)">–í–µ—Å (–∫–≥)</label>
                    <input type="number" id="input-w" inputmode="decimal">
                </div>
                <div style="flex:1">
                    <label id="label-r" style="font-size:11px; color:var(--tg-hint)">–ü–æ–≤—Ç–æ—Ä—ã</label>
                    <input type="number" id="input-r" inputmode="numeric">
                </div>
            </div>
            <button class="btn btn-primary" onclick="addSet()">–ó–∞–ø–∏—Å–∞—Ç—å</button>
        </div>

        <div id="current-session-block" class="card hidden">
            <h3 id="session-title">–°–µ–π—á–∞—Å: 0 XP</h3>
            <div id="current-list"></div>
            <button class="btn btn-success" style="margin-top: 15px;" onclick="finishWorkout()">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
        </div>

        <div class="card">
            <h3 style="font-size:14px; opacity:0.7">–ò—Å—Ç–æ—Ä–∏—è –±–∏—Ç–≤</h3>
            <div id="history-list"></div>
            <button class="btn btn-outline" onclick="safeReset()">–°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</button>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <div class="card" style="text-align: center;">
            <div style="font-size: 60px; margin-bottom: 10px;">üèÜ</div>
            <h2>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
            <div class="diff-badge" id="res-diff">–û—Ç–ª–∏—á–Ω–æ–µ –Ω–∞—á–∞–ª–æ</div>
            
            <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin: 20px 0;">
                <div style="font-size: 12px; opacity: 0.7;">–ü–æ–ª—É—á–µ–Ω–æ –æ–ø—ã—Ç–∞</div>
                <div style="font-size: 42px; font-weight: 900; color: var(--gold);" id="res-xp">+0 XP</div>
            </div>

            <div class="stat-grid">
                <div><div class="stat-val" id="res-vol">0</div><div class="stat-label">–¢–æ–Ω–Ω–∞–∂</div></div>
                <div><div class="stat-val" id="res-kcal">0</div><div class="stat-label">–ö–∫–∞–ª</div></div>
                <div><div class="stat-val" id="res-sets">0</div><div class="stat-label">–ü–æ–¥—Ö–æ–¥–æ–≤</div></div>
            </div>
            <button class="btn btn-primary" style="margin-top: 20px;" onclick="closeResult()">–í –º–µ–Ω—é</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // –ë–î –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π [–ù–∞–∑–≤–∞–Ω–∏–µ, MET, –¢–∏–ø]
        // –¢–∏–ø—ã: 0-—Å–∏–ª–∞, 1-—Å–≤–æ–π –≤–µ—Å, 2-–∫–æ—Ä/–≤—Ä–µ–º—è, 3-–∫–∞—Ä–¥–∏–æ
        const EX_DB = {
            chest: [["–ñ–∏–º –ª–µ–∂–∞", 6.0, 0], ["–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π", 5.5, 0], ["–û—Ç–∂–∏–º–∞–Ω–∏—è", 4.0, 1], ["–ë—Ä—É—Å—å—è", 5.0, 1]],
            back: [["–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è", 5.0, 1], ["–¢—è–≥–∞ —à—Ç–∞–Ω–≥–∏", 6.0, 0], ["–¢—è–≥–∞ –±–ª–æ–∫–∞", 4.5, 0], ["–¢—è–≥–∞ –≥–∞–Ω—Ç–µ–ª–∏", 5.0, 0]],
            legs: [["–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è", 7.0, 0], ["–°—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞", 8.0, 0], ["–ñ–∏–º –Ω–æ–≥–∞–º–∏", 5.0, 0], ["–í—ã–ø–∞–¥—ã", 6.0, 0]],
            shoulders: [["–ñ–∏–º –∞—Ä–º–µ–π—Å–∫–∏–π", 5.0, 0], ["–ú–∞—Ö–∏ –≥–∞–Ω—Ç–µ–ª—è–º–∏", 3.5, 0], ["–¢—è–≥–∞ –∫ –ª–∏—Ü—É", 3.0, 0]],
            arms: [["–ë–∏—Ü–µ–ø—Å —à—Ç–∞–Ω–≥–∞", 3.0, 0], ["–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∂–∏–º", 3.0, 0], ["–ú–æ–ª–æ—Ç–∫–∏", 3.0, 0]],
            abs: [["–ü–ª–∞–Ω–∫–∞", 3.0, 2], ["–°–∫—Ä—É—á–∏–≤–∞–Ω–∏—è", 3.5, 1], ["–ü–æ–¥—ä–µ–º –Ω–æ–≥", 4.0, 1]],
            cardio: [["–ë–µ–≥", 9.0, 3], ["–í–µ–ª–æ—Å–∏–ø–µ–¥", 7.0, 3], ["–≠–ª–ª–∏–ø—Å", 6.0, 3], ["–•–æ–¥—å–±–∞", 3.5, 3]]
        };

        const LEVELS = [
            { xp: 0, icon: "ü•ö", rank: "–Ø–π—Ü–æ" },
            { xp: 500, icon: "üê£", rank: "–ü—Ç–µ–Ω–µ—Ü" },
            { xp: 1500, icon: "üê•", rank: "–¶—ã–ø–ª–µ–Ω–æ–∫" },
            { xp: 4000, icon: "üêì", rank: "–ë–æ–µ–≤–æ–π –ü–µ—Ç—É—Ö" },
            { xp: 10000, icon: "ü¶Ö", rank: "–û—Ä–µ–ª" },
            { xp: 20000, icon: "ü¶ç", rank: "–ì–æ—Ä–∏–ª–ª–∞" },
            { xp: 40000, icon: "ü¶ñ", rank: "–î–∏–Ω–æ–∑–∞–≤—Ä" },
            { xp: 75000, icon: "üêâ", rank: "–î—Ä–∞–∫–æ–Ω" },
            { xp: 150000, icon: "üëë", rank: "–ö–æ—Ä–æ–ª—å –ñ–µ–ª–µ–∑–∞" }
        ];

        let profile = JSON.parse(localStorage.getItem('ip_profile'));
        let history = JSON.parse(localStorage.getItem('ip_history')) || [];
        let currentSession = JSON.parse(localStorage.getItem('ip_current')) || [];
        let totalXP = parseInt(localStorage.getItem('ip_xp')) || 0;
        
        // –ö—ç—à –¥–ª—è –∏–Ω–ø—É—Ç–æ–≤, —á—Ç–æ–±—ã –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–ª–∏—Å—å –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
        let inputsCache = {}; 

        init();

        function init() {
            if (!profile) {
                showScreen('screen-onboarding');
            } else {
                showScreen('screen-main');
                updateExList();
                renderMain();
            }
        }

        // --- –õ–û–ì–ò–ö–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
        function updateExList() {
            const cat = document.getElementById('select-cat').value;
            const exSelect = document.getElementById('select-ex');
            exSelect.innerHTML = EX_DB[cat].map((ex, idx) => `<option value="${idx}">${ex[0]}</option>`).join('');
            adaptInputs();
        }

        function adaptInputs() {
            const cat = document.getElementById('select-cat').value;
            const exIdx = document.getElementById('select-ex').value;
            const type = EX_DB[cat][exIdx][2];
            
            const lw = document.getElementById('label-w');
            const lr = document.getElementById('label-r');
            const iw = document.getElementById('input-w');
            const ir = document.getElementById('input-r');

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Å–º–µ–Ω–æ–π (–µ—Å–ª–∏ –±—ã–ª–∏)
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ –∫—ç—à–∞, –µ—Å–ª–∏ –µ—Å—Ç—å –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
            const cacheKey = `type_${type}`; // –ö—ç—à–∏—Ä—É–µ–º –ø–æ —Ç–∏–ø—É (—Å–∏–ª–∞, –∫–∞—Ä–¥–∏–æ –∏ —Ç.–¥.)

            if (type === 3) { // –ö–∞—Ä–¥–∏–æ
                lw.innerText = "–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å (1-10)";
                lr.innerText = "–ú–∏–Ω—É—Ç—ã";
                iw.placeholder = "5";
            } else if (type === 2) { // –ü–ª–∞–Ω–∫–∞ / –í—Ä–µ–º—è
                lw.innerText = "–°–ª–æ–∂–Ω–æ—Å—Ç—å (1-10)";
                lr.innerText = "–ú–∏–Ω—É—Ç—ã";
                iw.placeholder = "1";
            } else if (type === 1) { // –°–≤–æ–π –≤–µ—Å
                lw.innerText = "–î–æ–ø. –≤–µ—Å (–∫–≥)";
                lr.innerText = "–ü–æ–≤—Ç–æ—Ä—ã";
                iw.placeholder = "0";
            } else { // –°–∏–ª–∞
                lw.innerText = "–í–µ—Å —à—Ç–∞–Ω–≥–∏ (–∫–≥)";
                lr.innerText = "–ü–æ–≤—Ç–æ—Ä—ã";
                iw.placeholder = "0";
            }

            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π
            if (inputsCache[cacheKey]) {
                iw.value = inputsCache[cacheKey].w;
                ir.value = inputsCache[cacheKey].r;
            } else {
                iw.value = "";
                ir.value = "";
            }
        }
        
        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–Ω–ø—É—Ç–æ–≤ –¥–ª—è –∫—ç—à–∞
        document.getElementById('input-w').addEventListener('input', (e) => cacheInputs());
        document.getElementById('input-r').addEventListener('input', (e) => cacheInputs());

        function cacheInputs() {
            const cat = document.getElementById('select-cat').value;
            const exIdx = document.getElementById('select-ex').value;
            const type = EX_DB[cat][exIdx][2];
            const w = document.getElementById('input-w').value;
            const r = document.getElementById('input-r').value;
            inputsCache[`type_${type}`] = { w, r };
        }

        function saveProfile() {
            const w = parseFloat(document.getElementById('prof-weight').value);
            if (!w || w < 30) return tg.showAlert("–ù—É–∂–µ–Ω —Ä–µ–∞–ª—å–Ω—ã–π –≤–µ—Å –¥–ª—è —Ñ–æ—Ä–º—É–ª");
            profile = { weight: w, gender: document.getElementById('prof-gender').value };
            localStorage.setItem('ip_profile', JSON.stringify(profile));
            showScreen('screen-main');
            updateExList();
            renderMain();
        }

        // --- –õ–û–ì–ò–ö–ê –†–ê–°–ß–ï–¢–û–í ---
        function addSet() {
            const cat = document.getElementById('select-cat').value;
            const exIdx = document.getElementById('select-ex').value;
            const [name, met, type] = EX_DB[cat][exIdx];
            
            let w = parseFloat(document.getElementById('input-w').value) || 0;
            const r = parseFloat(document.getElementById('input-r').value) || 0;

            if (r <= 0) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–≤—Ç–æ—Ä—ã –∏–ª–∏ –≤—Ä–µ–º—è!");

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏
            if (type === 2 || type === 3) {
                if (w > 10) w = 10;
                if (w < 1) w = 5; // –î–µ—Ñ–æ–ª—Ç –µ—Å–ª–∏ –ø—É—Å—Ç–æ
            }
            if (w < 0) w = 0;

            let kcal = 0;
            let vol = 0;
            let xp = 0;
            const genderMod = profile.gender === 'female' ? 0.9 : 1.0;

            if (type === 3 || type === 2) { 
                // –ö–∞—Ä–¥–∏–æ —Ñ–æ—Ä–º—É–ª–∞: MET * (0.5 + w/10) * –≤–µ—Å * —á–∞—Å—ã
                const intensityCoeff = 0.5 + (w / 10); 
                kcal = met * intensityCoeff * profile.weight * (r / 60) * genderMod;
                vol = 0; 
            } else { 
                // –°–∏–ª–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∞
                const effectiveWeight = (type === 1) ? (profile.weight + w) : w;
                const timeInHours = (r * 4) / 3600; 
                const baseKcal = met * profile.weight * timeInHours * genderMod;
                const bonusKcal = (effectiveWeight * r) / 1000 * 50; // 50 –∫–∫–∞–ª –∑–∞ —Ç–æ–Ω–Ω—É
                
                kcal = baseKcal + bonusKcal;
                vol = effectiveWeight * r;
            }

            // XP –ë–∞–ª–∞–Ω—Å: –¢–æ–Ω–Ω–∞–∂/5 + –ö–∫–∞–ª*2
            xp = Math.round((vol / 5) + (kcal * 2));

            const set = { id: Date.now(), name, vol, kcal: Math.round(kcal), xp, w, r, type };
            currentSession.unshift(set);
            saveSession();
            
            // –û—á–∏—â–∞–µ–º –ø–æ–≤—Ç–æ—Ä—ã, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –≤–µ—Å (–¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∞)
            document.getElementById('input-r').value = "";
            tg.HapticFeedback.impactOccurred('medium');
            renderMain();
        }

        function deleteSet(id) {
            currentSession = currentSession.filter(s => s.id !== id);
            saveSession();
            renderMain();
        }

        function saveSession() {
            localStorage.setItem('ip_current', JSON.stringify(currentSession));
        }

        function renderMain() {
            document.getElementById('stat-xp').innerText = totalXP.toLocaleString();
            document.getElementById('stat-count').innerText = history.length;
            
            updateCharacter();

            const curDiv = document.getElementById('current-session-block');
            const curTotalXP = currentSession.reduce((a,c) => a + c.xp, 0);
            
            if (currentSession.length > 0) {
                curDiv.classList.remove('hidden');
                document.getElementById('session-title').innerText = `–°–µ–π—á–∞—Å: +${curTotalXP} XP`;
                
                document.getElementById('current-list').innerHTML = currentSession.map(s => `
                    <div class="list-item">
                        <div>
                            <b>${s.name}</b>
                            <div style="font-size:12px; opacity:0.7">${s.type > 1 ? s.r + ' –º–∏–Ω' : s.w + '–∫–≥ √ó ' + s.r}</div>
                        </div>
                        <div style="text-align:right">
                            <span style="color:var(--gold); font-weight:bold; font-size:14px;">+${s.xp} XP</span><br>
                            <span style="font-size:11px; opacity:0.5">${s.kcal} –∫–∫–∞–ª</span>
                            <span class="del-btn" onclick="deleteSet(${s.id})">‚úï</span>
                        </div>
                    </div>
                `).join('');
            } else {
                curDiv.classList.add('hidden');
            }

            const hList = document.getElementById('history-list');
            hList.innerHTML = history.slice(0, 3).map(h => `
                <div class="list-item" style="font-size: 13px;">
                    <div style="opacity: 0.8">${h.date}</div>
                    <div>
                        ${h.vol > 0 ? (h.vol/1000).toFixed(1) + '—Ç' : h.kcal + ' –∫–∫–∞–ª'} 
                        <span style="color:var(--gold); margin-left:8px; font-weight:bold">+${h.xp} XP</span>
                    </div>
                </div>
            `).join('') || '<div style="text-align:center; font-size:12px; opacity:0.5; padding:10px;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞. –¢–≤–æ–π –ø—É—Ç—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è!</div>';
        }

        function updateCharacter() {
            let current = LEVELS[0];
            let next = LEVELS[1];

            for (let i = 0; i < LEVELS.length; i++) {
                if (totalXP >= LEVELS[i].xp) {
                    current = LEVELS[i];
                    next = LEVELS[i+1] || { xp: totalXP * 1.5, rank: "–ú–∞–∫—Å–∏–º—É–º" };
                }
            }

            document.getElementById('main-char-icon').innerText = current.icon;
            document.getElementById('main-char-rank').innerText = current.rank;
            document.getElementById('stat-lvl').innerText = LEVELS.indexOf(current) + 1;
            
            document.getElementById('main-char-xp').innerText = `${totalXP} XP`;
            document.getElementById('main-char-next').innerText = `–¶–µ–ª—å: ${next.xp}`;

            const percent = Math.min(100, Math.max(0, ((totalXP - current.xp) / (next.xp - current.xp)) * 100));
            document.getElementById('xp-fill').style.width = percent + "%";
        }

        function finishWorkout() {
            if (currentSession.length === 0) return;

            const vol = currentSession.reduce((a, c) => a + c.vol, 0);
            const kcal = currentSession.reduce((a, c) => a + c.kcal, 0);
            const xp = currentSession.reduce((a, c) => a + c.xp, 0);
            const sets = currentSession.length;

            let diffText = "–û—Ç–ª–∏—á–Ω–æ–µ –Ω–∞—á–∞–ª–æ!";
            if (history.length > 0) {
                const prevXP = history[0].xp;
                if (xp > prevXP) diffText = "–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥ XP! üî•";
                else diffText = "–•–æ—Ä–æ—à–∞—è —Ä–∞–±–æ—Ç–∞ üí™";
            }

            const record = {
                date: new Date().toLocaleDateString('ru-RU', {day:'numeric', month:'short'}),
                vol, kcal, xp, sets
            };

            history.unshift(record);
            totalXP += xp;
            
            localStorage.setItem('ip_history', JSON.stringify(history));
            localStorage.setItem('ip_xp', totalXP);
            localStorage.removeItem('ip_current');
            currentSession = [];

            document.getElementById('res-xp').innerText = "+" + xp + " XP";
            document.getElementById('res-diff').innerText = diffText;
            document.getElementById('res-vol').innerText = vol > 0 ? (vol/1000).toFixed(1) + " —Ç" : "–ö–∞—Ä–¥–∏–æ";
            document.getElementById('res-kcal').innerText = kcal;
            document.getElementById('res-sets').innerText = sets;

            showScreen('screen-result');
            tg.HapticFeedback.notificationOccurred('success');
            renderMain();
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById(id).classList.add('active-screen');
            window.scrollTo(0,0);
        }
        
        function closeResult() {
            showScreen('screen-main');
        }

        function safeReset() {
            if (confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —É—Ä–æ–≤–µ–Ω—å? –≠—Ç–æ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.")) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>