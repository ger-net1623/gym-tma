<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IronPath - RPG Tracker</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { 
            --tg-bg: var(--tg-theme-bg-color, #1a1a1a);
            --tg-text: var(--tg-theme-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #aaaaaa);
            --tg-link: var(--tg-theme-link-color, #3390ec);
            --tg-btn: var(--tg-theme-button-color, #3390ec);
            --tg-btn-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary: var(--tg-theme-secondary-bg-color, #2b2b2b);
            
            --green: #4ade80;
            --red: #ef4444;
            --gold: #fbbf24;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--tg-bg); 
            color: var(--tg-text); 
            margin: 0; padding: 16px;
            max-width: 600px; margin: 0 auto; 
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .screen { display: none; animation: fadeIn 0.3s ease-out; }
        .active-screen { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .card { 
            background: var(--tg-secondary); 
            padding: 20px; 
            border-radius: 20px; 
            margin-bottom: 16px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        h1, h2, h3 { margin: 0 0 10px 0; font-weight: 800; }
        p { color: var(--tg-hint); font-size: 14px; line-height: 1.4; margin-bottom: 15px; }

        .btn { 
            width: 100%; padding: 16px; border: none; border-radius: 14px; 
            font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-primary { background: var(--tg-btn); color: var(--tg-btn-text); }
        .btn-success { background: var(--green); color: #000; }
        .btn-outline { background: transparent; border: 1px solid var(--tg-hint); color: var(--tg-hint); font-size: 13px; margin-top: 10px; padding: 10px; }
        .btn:active { transform: scale(0.98); opacity: 0.8; }

        input, select { 
            width: 100%; padding: 14px; margin-bottom: 12px; 
            background: var(--tg-bg); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; 
            color: var(--tg-text); font-size: 16px; box-sizing: border-box;
            outline: none;
        }
        input:focus { border-color: var(--tg-link); }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; text-align: center; }
        .stat-val { font-size: 20px; font-weight: 800; color: var(--tg-link); }
        .stat-label { font-size: 10px; text-transform: uppercase; color: var(--tg-hint); margin-top: 4px; }

        /* –ü–µ—Ä—Å–æ–Ω–∞–∂ –∏ XP */
        .char-container { text-align: center; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 15px; }
        .char-icon { font-size: 64px; display: block; margin-bottom: 5px; animation: pulse 3s infinite; }
        .hint-block {
            color: var(--gold); font-size: 11px; margin: 10px 0;
            background: rgba(251, 191, 36, 0.1); padding: 8px 12px;
            border-radius: 8px; border-left: 3px solid var(--gold); display: block;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        .xp-bar-bg { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-top: 8px; overflow: hidden; position: relative; }
        .xp-bar-fill { height: 100%; background: linear-gradient(90deg, var(--tg-link), #8b5cf6); width: 0%; transition: width 0.5s; }

        .list-item { 
            padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); 
            display: flex; justify-content: space-between; align-items: center;
        }
        .del-btn { 
            color: var(--red); padding: 5px 10px; font-size: 18px; cursor: pointer; 
            background: rgba(239, 68, 68, 0.1); border-radius: 8px; margin-left: 10px;
        }

        .diff-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-top: 5px; background: rgba(255,255,255,0.1);}
        .diff-pos { background: rgba(74, 222, 128, 0.2); color: var(--green); }
        .diff-neg { background: rgba(239, 68, 68, 0.2); color: var(--red); }
        
        .hidden { display: none !important; }
        
        .input-row { display: flex; gap: 10px; }
        .input-group { flex: 1; }
        .input-label { font-size: 11px; color: var(--tg-hint); margin-bottom: 4px; display: block; }
    </style>
</head>
<body>

    <div id="screen-onboarding" class="screen">
        <div class="card" style="text-align: center; padding-top: 40px; min-height: 300px; display: flex; flex-direction: column; justify-content: space-between;">
            <div>
                <div style="font-size: 60px; margin-bottom: 20px;">‚öîÔ∏è</div>
                <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
                <p>IronPath ‚Äî RPG-—Ç—Ä–µ–∫–µ—Ä —Ç–≤–æ–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.</p>
                <p>–ö–∞–∂–¥–∞—è –∫–∞–ø–ª—è –ø–æ—Ç–∞ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ XP. –ü—Ä–æ–π–¥–∏ –ø—É—Ç—å –æ—Ç "–ù–æ–≤–∏—á–∫–∞" –¥–æ "–ö–æ—Ä–æ–ª—è –ñ–µ–ª–µ–∑–∞".</p>
            </div>
            <button class="btn btn-primary" onclick="showScreen('screen-profile')">–°–æ–∑–¥–∞—Ç—å –±–æ–π—Ü–∞</button>
        </div>
    </div>

    <div id="screen-profile" class="screen">
        <div class="card">
            <h2>–î–∞–Ω–Ω—ã–µ –±–æ–π—Ü–∞</h2>
            <p>–í–ª–∏—è—é—Ç –Ω–∞ —Ç–æ—á–Ω–æ—Å—Ç—å —Ä–∞—Å—á–µ—Ç–∞ –∫–∞–ª–æ—Ä–∏–π –∏ —Å–∏–ª—ã.</p>
            
            <div class="input-row">
                <div class="input-group">
                    <label class="input-label">–í–µ—Å (–∫–≥)</label>
                    <input type="number" id="prof-weight" placeholder="80" inputmode="decimal">
                </div>
                <div class="input-group">
                    <label class="input-label">–†–æ—Å—Ç (—Å–º)</label>
                    <input type="number" id="prof-height" placeholder="175" inputmode="numeric">
                </div>
            </div>

            <div class="input-row">
                <div class="input-group">
                    <label class="input-label">–í–æ–∑—Ä–∞—Å—Ç</label>
                    <input type="number" id="prof-age" placeholder="25" inputmode="numeric">
                </div>
                <div class="input-group">
                    <label class="input-label">–ü–æ–ª</label>
                    <select id="prof-gender">
                        <option value="male">–ú—É–∂—á–∏–Ω–∞</option>
                        <option value="female">–ñ–µ–Ω—â–∏–Ω–∞</option>
                    </select>
                </div>
            </div>

            <label class="input-label">–ì–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å</label>
            <select id="prof-goal">
                <option value="strength">–°–∏–ª–∞ (–ü–∞—É—ç—Ä–ª–∏—Ñ—Ç–∏–Ω–≥) üí™</option>
                <option value="muscle">–ì–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è (–ú–∞—Å—Å–∞) üèãÔ∏è</option>
                <option value="health">–ó–¥–æ—Ä–æ–≤—å–µ / –¢–æ–Ω—É—Å ü´Ä</option>
                <option value="fatloss">–°–∂–∏–≥–∞–Ω–∏–µ –∂–∏—Ä–∞ üî•</option>
            </select>
            
            <button class="btn btn-primary" style="margin-top: 10px;" onclick="saveProfile()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
        </div>
    </div>

    <div id="screen-main" class="screen">
        <div class="card">
            <div class="char-container">
                <span class="char-icon" id="main-char-icon">üê£</span>
                <div style="font-weight: bold; font-size: 18px;" id="main-char-rank">–ù–æ–≤–∏—á–æ–∫</div>
                <div class="xp-bar-bg"><div class="xp-bar-fill" id="xp-fill"></div></div>
                <div style="display:flex; justify-content:space-between; font-size: 11px; color: var(--tg-hint); margin-top: 5px;">
                    <span id="main-char-xp">0 XP</span>
                    <span id="main-char-next">–¶–µ–ª—å: 100</span>
                </div>
            </div>
            <div class="stat-grid">
                <div><div class="stat-val" id="stat-xp">0</div><div class="stat-label">–í—Å–µ–≥–æ XP</div></div>
                <div><div class="stat-val" id="stat-count">0</div><div class="stat-label">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div></div>
                <div><div class="stat-val" id="stat-lvl">1</div><div class="stat-label">–£—Ä–æ–≤–µ–Ω—å</div></div>
            </div>
        </div>

        <div class="card">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
            <select id="select-cat" onchange="updateExList()">
                <option value="chest">–ì—Ä—É–¥—å</option>
                <option value="back">–°–ø–∏–Ω–∞</option>
                <option value="legs">–ù–æ–≥–∏ / –Ø–≥–æ–¥–∏—Ü—ã</option>
                <option value="shoulders">–ü–ª–µ—á–∏</option>
                <option value="arms">–†—É–∫–∏</option>
                <option value="abs">–ü—Ä–µ—Å—Å / –ö–æ—Ä</option>
                <option value="cardio">–ö–∞—Ä–¥–∏–æ</option>
            </select>
            <select id="select-ex" onchange="adaptInputs()"></select>
            
            <div id="hint-dumbbell" class="hint-block hidden">
                üí° –í–µ—Å –æ–¥–Ω–æ–π –≥–∞–Ω—Ç–µ–ª–∏. –°–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ —É–¥–≤–æ–∏—Ç —Ç–æ–Ω–Ω–∞–∂.
            </div>
            <div id="hint-bodyweight" class="hint-block hidden">
                üí° –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º –≤–µ—Å–æ–º. –£–∫–∞–∂–∏ –¥–æ–ø. –≤–µ—Å, –µ—Å–ª–∏ –µ—Å—Ç—å (–∏–ª–∏ 0).
            </div>

            <div id="input-container-strength" class="input-row">
                <div class="input-group">
                    <label id="label-w" class="input-label">–í–µ—Å (–∫–≥)</label>
                    <input type="number" id="input-w" inputmode="decimal">
                </div>
                <div class="input-group">
                    <label id="label-r" class="input-label">–ü–æ–≤—Ç–æ—Ä—ã</label>
                    <input type="number" id="input-r" inputmode="numeric">
                </div>
            </div>

            <div id="input-container-cardio" class="hidden">
                <label class="input-label">–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å</label>
                <select id="input-cardio-intensity">
                    </select>
                <label class="input-label">–í—Ä–µ–º—è (–º–∏–Ω—É—Ç—ã)</label>
                <input type="number" id="input-cardio-time" placeholder="–ú–∏–Ω" inputmode="numeric">
            </div>

            <button class="btn btn-primary" style="margin-top:12px;" onclick="addSet()">–ó–∞–ø–∏—Å–∞—Ç—å –ø–æ–¥—Ö–æ–¥</button>
        </div>

        <div id="current-session-block" class="card hidden">
            <h3 id="session-title">–°–µ–π—á–∞—Å: 0 XP</h3>
            <div id="current-list"></div>
            <button class="btn btn-success" style="margin-top: 15px;" onclick="finishWorkout()">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
        </div>

        <div class="card">
            <h3 style="font-size:14px; opacity:0.7">–ò—Å—Ç–æ—Ä–∏—è –±–∏—Ç–≤</h3>
            <div id="history-list"></div>
            <button class="btn btn-outline" style="border-color: var(--red); color: var(--red);" onclick="safeReset()">üß® –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</button>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <div class="card" style="text-align: center;">
            <div style="font-size: 60px; margin-bottom: 10px;">üèÜ</div>
            <h2 id="res-title">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
            <div id="res-diff-badge" class="diff-badge hidden"></div>
            
            <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin: 20px 0;">
                <div style="font-size: 12px; opacity: 0.7;">–ü–æ–ª—É—á–µ–Ω–æ –æ–ø—ã—Ç–∞</div>
                <div style="font-size: 42px; font-weight: 900; color: var(--gold);" id="res-xp">+0 XP</div>
            </div>

            <div class="stat-grid">
                <div><div class="stat-val" id="res-vol">0</div><div class="stat-label">–û–±—ä–µ–º (–∫–≥)</div></div>
                <div><div class="stat-val" id="res-kcal">0</div><div class="stat-label">–ö–∫–∞–ª</div></div>
                <div><div class="stat-val" id="res-time">0</div><div class="stat-label">–ú–∏–Ω</div></div>
            </div>

            <div id="res-msg" style="margin: 15px 0; font-size: 14px; font-style: italic; color: var(--tg-hint);"></div>
            <div id="res-tip" class="hint-block" style="text-align: left; margin-top: 15px; background: rgba(59, 130, 246, 0.1); border-color: var(--tg-link); color: var(--tg-text);"></div>
            
            <button class="btn btn-primary" style="margin-top: 20px;" onclick="closeResult()">–í –º–µ–Ω—é</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        /* --- –ë–î –£–ü–†–ê–ñ–ù–ï–ù–ò–ô (v1.5 FINAL) --- 
           [–ù–∞–∑–≤–∞–Ω–∏–µ, MET_Active, –¢–∏–ø, –ú–Ω–æ–∂–∏—Ç–µ–ª—å–ù–∞–≥—Ä—É–∑–∫–∏]
           –¢–∏–ø—ã: 0=–°–∏–ª–∞, 1=–°–≤–æ–π–í–µ—Å, 2=–°—Ç–∞—Ç–∏–∫–∞, 3=–ö–∞—Ä–¥–∏–æ
           –ú–Ω–æ–∂–∏—Ç–µ–ª—å: 1 (—à—Ç–∞–Ω–≥–∞), 2 (–≥–∞–Ω—Ç–µ–ª–∏/–¥–≤–µ —Ä—É–∫–∏) */
        
        const EX_DB = {
            legs: [
                ["–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è (–®—Ç–∞–Ω–≥–∞)", 6.0, 0, 1],
                ["–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è (–ì–∞–Ω—Ç–µ–ª—å/–ö—É–±–æ–∫)", 5.5, 0, 2],
                ["–ñ–∏–º –Ω–æ–≥–∞–º–∏", 5.0, 0, 1],
                ["–°—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞", 7.0, 0, 1],
                ["–†—É–º—ã–Ω—Å–∫–∞—è —Ç—è–≥–∞ (RDL)", 6.0, 0, 1],
                ["–í—ã–ø–∞–¥—ã (—Å –ì–∞–Ω—Ç–µ–ª—è–º–∏)", 5.5, 0, 2],
                ["–í—ã–ø–∞–¥—ã (–°–≤–æ–π –≤–µ—Å)", 4.5, 1, 0],
                ["–ë–æ–ª–≥–∞—Ä—Å–∫–∏–µ –ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è", 6.0, 0, 2],
                ["–†–∞–∑–≥–∏–±–∞–Ω–∏–µ –Ω–æ–≥", 3.5, 0, 1],
                ["–°–≥–∏–±–∞–Ω–∏–µ –Ω–æ–≥", 3.5, 0, 1]
            ],
            back: [
                ["–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è", 5.0, 1, 0],
                ["–¢—è–≥–∞ —à—Ç–∞–Ω–≥–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ", 6.0, 0, 1],
                ["–¢—è–≥–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞", 4.0, 0, 1],
                ["–¢—è–≥–∞ –≥–∞–Ω—Ç–µ–ª–∏ (–æ–¥–Ω–æ–π —Ä—É–∫–æ–π)", 4.5, 0, 2], /* FIX: –ú–Ω–æ–∂–∏—Ç–µ–ª—å 2, —Ç.–∫. –¥–µ–ª–∞–µ–º –Ω–∞ –æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã */
                ["–¢—è–≥–∞ –Ω–∏–∂–Ω–µ–≥–æ –±–ª–æ–∫–∞", 4.0, 0, 1],
                ["–ì–∏–ø–µ—Ä—ç–∫—Å—Ç–µ–Ω–∑–∏—è", 3.5, 1, 0],
                ["–ü—É–ª–æ–≤–µ—Ä (–ë–ª–æ–∫)", 3.5, 0, 1]
            ],
            chest: [
                ["–ñ–∏–º –ª–µ–∂–∞ (–®—Ç–∞–Ω–≥–∞)", 5.5, 0, 1],
                ["–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –ª–µ–∂–∞", 5.5, 0, 2],
                ["–ñ–∏–º –ø–æ–¥ —É–≥–ª–æ–º (–®—Ç–∞–Ω–≥–∞)", 5.5, 0, 1],
                ["–ñ–∏–º –ø–æ–¥ —É–≥–ª–æ–º (–ì–∞–Ω—Ç–µ–ª–∏)", 5.5, 0, 2],
                ["–û—Ç–∂–∏–º–∞–Ω–∏—è", 4.0, 1, 0],
                ["–û—Ç–∂–∏–º–∞–Ω–∏—è –Ω–∞ –±—Ä—É—Å—å—è—Ö", 5.0, 1, 0],
                ["–°–≤–µ–¥–µ–Ω–∏–µ —Ä—É–∫ (–ë–∞–±–æ—á–∫–∞)", 3.0, 0, 1]
            ],
            shoulders: [
                ["–ê—Ä–º–µ–π—Å–∫–∏–π –∂–∏–º (–®—Ç–∞–Ω–≥–∞)", 5.0, 0, 1],
                ["–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π —Å–∏–¥—è", 5.0, 0, 2],
                ["–ú–∞—Ö–∏ –≥–∞–Ω—Ç–µ–ª—è–º–∏ –≤ —Å—Ç–æ—Ä–æ–Ω—ã", 3.5, 0, 2],
                ["–ú–∞—Ö–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ (–ó–∞–¥–Ω—è—è –¥–µ–ª—å—Ç–∞)", 3.5, 0, 2],
                ["–¢—è–≥–∞ –∫ –ª–∏—Ü—É (–ë–ª–æ–∫)", 3.5, 0, 1]
            ],
            arms: [
                ["–ü–æ–¥—ä–µ–º —à—Ç–∞–Ω–≥–∏ –Ω–∞ –±–∏—Ü–µ–ø—Å", 3.5, 0, 1],
                ["–ü–æ–¥—ä–µ–º –≥–∞–Ω—Ç–µ–ª–µ–π (–ë–∏—Ü–µ–ø—Å)", 3.5, 0, 2],
                ["–ú–æ–ª–æ—Ç–∫–∏", 3.5, 0, 2],
                ["–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∂–∏–º", 3.5, 0, 1],
                ["–†–∞–∑–≥–∏–±–∞–Ω–∏–µ –Ω–∞ –±–ª–æ–∫–µ (–¢—Ä–∏—Ü–µ–ø—Å)", 3.0, 0, 1]
            ],
            abs: [
                ["–°–∫—Ä—É—á–∏–≤–∞–Ω–∏—è", 3.0, 1, 0],
                ["–ü–æ–¥—ä–µ–º –Ω–æ–≥ –≤ –≤–∏—Å–µ", 4.0, 1, 0],
                ["–ü–ª–∞–Ω–∫–∞", 3.5, 2, 0],
                ["–†—É—Å—Å–∫–∏–π —Ç–≤–∏—Å—Ç", 3.5, 1, 0]
            ],
            cardio: [
                ["–ë–µ–≥", 9.0, 3, 0],
                ["–•–æ–¥—å–±–∞", 3.5, 3, 0],
                ["–≠–ª–ª–∏–ø—Å", 6.0, 3, 0],
                ["–í–µ–ª–æ—Ç—Ä–µ–Ω–∞–∂–µ—Ä", 6.0, 3, 0],
                ["–ì—Ä–µ–±–ª—è", 8.0, 3, 0],
                ["–°–∫–∞–∫–∞–ª–∫–∞", 10.0, 3, 0]
            ]
        };

        const LEVELS = [
            { xp: 0, icon: "ü•ö", rank: "–Ø–π—Ü–æ" },
            { xp: 500, icon: "üê£", rank: "–ù–æ–≤–∏—á–æ–∫" },
            { xp: 1500, icon: "üê•", rank: "–õ—é–±–∏—Ç–µ–ª—å" },
            { xp: 4000, icon: "üêì", rank: "–ë–æ–µ—Ü" },
            { xp: 10000, icon: "üêó", rank: "–ê—Ç–ª–µ—Ç" },
            { xp: 25000, icon: "ü¶ç", rank: "–ú–∞—à–∏–Ω–∞" },
            { xp: 60000, icon: "ü¶ñ", rank: "–¢–∏—Ç–∞–Ω" },
            { xp: 150000, icon: "üëë", rank: "–ö–æ—Ä–æ–ª—å –ñ–µ–ª–µ–∑–∞" }
        ];

        const TIPS = [
            "–ë–∞–∑–æ–≤—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è ‚Äî –æ—Å–Ω–æ–≤–∞ —Ç–≤–æ–µ–π —Å–∏–ª—ã. –ù–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–π –∏—Ö.",
            "–°–æ–Ω ‚Äî –ª—É—á—à–∏–π –∞–Ω–∞–±–æ–ª–∏–∫. –°–ø–∏ –Ω–µ –º–µ–Ω–µ–µ 7-8 —á–∞—Å–æ–≤.",
            "–ü—Ä–æ–≥—Ä–µ—Å—Å–∏—è –Ω–∞–≥—Ä—É–∑–æ–∫ ‚Äî –∫–ª—é—á –∫ —Ä–æ—Å—Ç—É. –°—Ç–∞—Ä–∞–π—Å—è –¥–µ–ª–∞—Ç—å —á—É—Ç—å –±–æ–ª—å—à–µ.",
            "–ù–µ –∑–∞–±—ã–≤–∞–π –ø–∏—Ç—å –≤–æ–¥—É –≤–æ –≤—Ä–µ–º—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.",
            "–†–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ –æ–¥–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.",
            "–†–∞—Å—Ç—è–∂–∫–∞ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —É—Å–∫–æ—Ä—è–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ."
        ];

        const CARDIO_INTENSITY = {
            default: { 3: "–õ–µ–≥–∫–∞—è (–†–∞–∑–º–∏–Ω–∫–∞)", 6: "–°—Ä–µ–¥–Ω—è—è (–ü–æ—Ç)", 9: "–í—ã—Å–æ–∫–∞—è (–¢—è–∂–µ–ª–æ)", 11: "–ú–∞–∫—Å–∏–º—É–º" },
            walk: { 3: "–ü—Ä–æ–≥—É–ª–∫–∞", 6: "–ë–æ–¥—Ä—ã–π —à–∞–≥", 9: "–í –≥–æ—Ä—É / –û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ", 11: "–°–ø–æ—Ä—Ç–∏–≤–Ω–∞—è —Ö–æ–¥—å–±–∞" }
        };

        let profile = JSON.parse(localStorage.getItem('ip_profile'));
        let history = JSON.parse(localStorage.getItem('ip_history')) || [];
        let currentSession = JSON.parse(localStorage.getItem('ip_current')) || [];
        let totalXP = parseInt(localStorage.getItem('ip_xp')) || 0;

        init();

        function init() {
            tg.ready();
            if (!profile) {
                showScreen('screen-onboarding');
            } else {
                showScreen('screen-main');
                updateExList();
                renderMain();
            }
        }

        function updateExList() {
            const cat = document.getElementById('select-cat').value;
            const exSelect = document.getElementById('select-ex');
            exSelect.innerHTML = EX_DB[cat].map((ex, idx) => `<option value="${idx}">${ex[0]}</option>`).join('');
            adaptInputs();
        }

        function adaptInputs() {
            const cat = document.getElementById('select-cat').value;
            const exIdx = document.getElementById('select-ex').value;
            const [name, met, type, multiplier] = EX_DB[cat][exIdx];

            const strContainer = document.getElementById('input-container-strength');
            const cardioContainer = document.getElementById('input-container-cardio');
            const hintDumbbell = document.getElementById('hint-dumbbell');
            const hintBody = document.getElementById('hint-bodyweight');
            const labelW = document.getElementById('label-w');
            const labelR = document.getElementById('label-r');

            document.getElementById('input-w').value = '';
            document.getElementById('input-r').value = '';

            if (type === 3) { // –ö–∞—Ä–¥–∏–æ
                strContainer.classList.add('hidden');
                cardioContainer.classList.remove('hidden');
                hintDumbbell.classList.add('hidden');
                hintBody.classList.add('hidden');
                
                const intensitySelect = document.getElementById('input-cardio-intensity');
                const iMap = name.includes('–•–æ–¥—å–±–∞') ? CARDIO_INTENSITY.walk : CARDIO_INTENSITY.default;
                intensitySelect.innerHTML = Object.entries(iMap).map(([val, txt]) => 
                    `<option value="${val}" ${val==6?'selected':''}>${txt}</option>`
                ).join('');

            } else { // –°–∏–ª–æ–≤—ã–µ
                strContainer.classList.remove('hidden');
                cardioContainer.classList.add('hidden');
                
                hintDumbbell.classList.toggle('hidden', multiplier !== 2);
                hintBody.classList.toggle('hidden', type !== 1);

                if (type === 2) { 
                    labelW.innerText = "–î–æ–ø. –≤–µ—Å (–∫–≥)";
                    labelR.innerText = "–í—Ä–µ–º—è (—Å–µ–∫)";
                } else if (type === 1) { 
                    labelW.innerText = "–î–æ–ø. –≤–µ—Å (–∫–≥)";
                    labelR.innerText = "–ü–æ–≤—Ç–æ—Ä—ã";
                } else {
                    labelW.innerText = "–í–µ—Å (–∫–≥)";
                    labelR.innerText = "–ü–æ–≤—Ç–æ—Ä—ã";
                }
            }
        }

        function saveProfile() {
            const w = parseFloat(document.getElementById('prof-weight').value);
            const h = parseFloat(document.getElementById('prof-height').value);
            const a = parseFloat(document.getElementById('prof-age').value);
            
            if (!w || w < 30 || !h || !a) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!");
            
            profile = { 
                weight: w, height: h, age: a,
                gender: document.getElementById('prof-gender').value,
                goal: document.getElementById('prof-goal').value
            };
            
            localStorage.setItem('ip_profile', JSON.stringify(profile));
            showScreen('screen-main');
            updateExList();
            renderMain();
        }

        // --- –ú–ê–¢–ï–ú–ê–¢–ò–ö–ê (FIXED) ---
        function getBMR() {
            let s = (profile.gender === 'male') ? 5 : -161;
            return 10 * profile.weight + 6.25 * profile.height - 5 * profile.age + s;
        }

        function saveSession() {
            localStorage.setItem('ip_current', JSON.stringify(currentSession));
        }

        function addSet() {
            const cat = document.getElementById('select-cat').value;
            const exIdx = document.getElementById('select-ex').value;
            const [name, metBase, type, multiplier] = EX_DB[cat][exIdx];
            
            let w = 0, r = 0, kcal = 0, vol = 0, xp = 0;
            // BMR –∑–∞ –º–∏–Ω—É—Ç—É (—á—Ç–æ–±—ã —É—á–µ—Å—Ç—å –±–∞–∑–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥ –≤–æ –≤—Ä–µ–º—è —Å–µ—Ç–∞)
            const bmrPerMin = getBMR() / 1440; 

            if (type === 3) { // –ö–ê–†–î–ò–û
                const intensity = parseFloat(document.getElementById('input-cardio-intensity').value);
                const duration = parseFloat(document.getElementById('input-cardio-time').value);
                if (!duration) return tg.showAlert("–£–∫–∞–∂–∏ –≤—Ä–µ–º—è!");
                
                // FIX: –¢–æ—á–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ –ö–∞—Ä–¥–∏–æ (MET * –í–µ—Å * –ß–∞—Å—ã)
                // intensity –∑–¥–µ—Å—å –≤—ã—Å—Ç—É–ø–∞–µ—Ç –∫–∞–∫ MET
                kcal = intensity * profile.weight * (duration / 60);
                
                vol = 0; 
                xp = Math.round(kcal * 1.5); 
                r = duration; 
                w = 0;

            } else { // –°–ò–õ–û–í–´–ï / –°–¢–ê–¢–ò–ö–ê
                w = parseFloat(document.getElementById('input-w').value) || 0;
                r = parseFloat(document.getElementById('input-r').value);
                if (!r) return tg.showAlert("–£–∫–∞–∂–∏ –ø–æ–≤—Ç–æ—Ä—ã/–≤—Ä–µ–º—è!");

                // –†–∞—Å—á–µ—Ç –æ–±—ä–µ–º–∞
                let load = w;
                if (type === 1) load = 0; 
                if (multiplier === 2) load = w * 2; 
                
                if (type === 2) {
                    // FIX: –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º –¥–ª—è —Å—Ç–∞—Ç–∏–∫–∏ (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ 0)
                    // –í–µ—Å —Ç–µ–ª–∞ (–µ—Å–ª–∏ –±–µ–∑ –¥–æ–ø –≤–µ—Å–∞) —Ç–æ–∂–µ —Å–æ–∑–¥–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –≤ –ø–ª–∞–Ω–∫–µ
                    let effectiveWeight = w + (profile.weight * 0.6); // 60% –≤–µ—Å–∞ —Ç–µ–ª–∞ –≤ —Å—Ç–∞—Ç–∏–∫–µ
                    vol = Math.round(effectiveWeight * (r / 10)); // —É—Å–ª–æ–≤–Ω—ã–π –æ–±—ä–µ–º
                } else {
                    vol = load * r;
                }
                
                // –ö–∞–ª–æ—Ä–∏–∏
                // –í—Ä–µ–º—è –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π –≤ –º–∏–Ω—É—Ç–∞—Ö
                let timeUnderTensionMin = (type === 2) ? (r / 60) : (r * 4 / 60); 
                
                // –ë–∞–∑–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥ –∑–∞ —ç—Ç–æ –≤—Ä–µ–º—è + –ê–∫—Ç–∏–≤–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ (MET)
                let baseBurn = bmrPerMin * timeUnderTensionMin;
                let activeBurn = (metBase * 3.5 * profile.weight / 200) * timeUnderTensionMin;
                
                // EPOC (–î–æ–∂–∏–≥–∞–Ω–∏–µ) - –±–æ–Ω—É—Å –∑–∞ —Ç—è–∂–µ—Å—Ç—å
                let liftBonus = 2 + (vol / 150); 
                
                kcal = baseBurn + activeBurn + liftBonus;
                
                // XP (–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞)
                xp = Math.round((vol / 25) + (kcal * 2));
                // Cap –Ω–∞ –æ–¥–∏–Ω –ø–æ–¥—Ö–æ–¥, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å –∏–≥—Ä—É –æ—à–∏–±–∫–∞–º–∏ –≤–≤–æ–¥–∞
                if (xp > 300) xp = 300; 
            }

            currentSession.unshift({ 
                id: Date.now(), 
                name, vol, kcal: Math.round(kcal), xp, w, r, type, multiplier 
            });
            
            saveSession();
            tg.HapticFeedback.impactOccurred('medium');
            renderMain();
            
            if (type !== 3) document.getElementById('input-r').value = '';
        }

        function deleteSet(id) {
            currentSession = currentSession.filter(s => s.id !== id);
            saveSession();
            renderMain();
        }

        function finishWorkout() {
            if (currentSession.length === 0) return;

            const vol = currentSession.reduce((a, c) => a + c.vol, 0);
            const kcal = currentSession.reduce((a, c) => a + c.kcal, 0);
            let xp = currentSession.reduce((a, c) => a + c.xp, 0);
            
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è XP (–±–∞–ª–∞–Ω—Å –∏–≥—Ä—ã)
            xp = Math.min(xp, 1500);

            // –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ (FIX: –£—á–µ—Ç –æ—Ç–¥—ã—Ö–∞)
            let totalMinutes = 0;
            let isCardioSession = true; // –§–ª–∞–≥ –¥–ª—è —Ç–∏–ø–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
            
            currentSession.forEach(s => {
                if (s.type === 3) {
                    totalMinutes += s.r;
                } else {
                    isCardioSession = false;
                    totalMinutes += 2.5; // –°–µ—Ç + –û—Ç–¥—ã—Ö
                }
            });

            // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–æ—à–ª—ã–º (FIX: –£–º–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ)
            let diffPercent = 0;
            let diffType = 'neutral';
            
            if (history.length > 0) {
                // –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É —Ç–æ–≥–æ –∂–µ —Ç–∏–ø–∞
                const prev = history.find(h => h.isCardio === isCardioSession);
                
                if (prev) {
                    let metric = isCardioSession ? 'kcal' : 'vol';
                    let currVal = isCardioSession ? kcal : vol;
                    let prevVal = isCardioSession ? prev.kcal : prev.vol;
                    
                    if (prevVal > 0) {
                        diffPercent = ((currVal - prevVal) / prevVal) * 100;
                        if (diffPercent > 5) diffType = 'pos';
                        if (diffPercent < -5) diffType = 'neg';
                    }
                }
            }

            const record = {
                date: Date.now(),
                dateStr: new Date().toLocaleDateString('ru-RU', {day:'numeric', month:'short'}),
                vol, kcal, xp, time: Math.round(totalMinutes),
                isCardio: isCardioSession
            };
            
            history.unshift(record);
            totalXP += xp;
            
            localStorage.setItem('ip_history', JSON.stringify(history));
            localStorage.setItem('ip_xp', totalXP);
            localStorage.removeItem('ip_current');
            currentSession = [];

            // –†–µ–Ω–¥–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            document.getElementById('res-xp').innerText = `+${xp} XP`;
            document.getElementById('res-vol').innerText = vol;
            document.getElementById('res-kcal').innerText = Math.round(kcal);
            document.getElementById('res-time').innerText = Math.round(totalMinutes);
            
            // –°–æ–≤–µ—Ç –¥–Ω—è
            document.getElementById('res-tip').innerText = "üí° –°–æ–≤–µ—Ç: " + TIPS[Math.floor(Math.random() * TIPS.length)];

            // –ë–µ–π–¥–∂
            const badge = document.getElementById('res-diff-badge');
            if (diffType !== 'neutral') {
                badge.classList.remove('hidden', 'diff-pos', 'diff-neg');
                badge.classList.add(diffType === 'pos' ? 'diff-pos' : 'diff-neg');
                badge.innerText = (diffType === 'pos' ? '‚ñ≤' : '‚ñº') + ` ${Math.abs(diffPercent).toFixed(1)}% –∫ –ø—Ä–æ—à–ª–æ–π`;
            } else {
                badge.classList.add('hidden');
            }

            const msgBox = document.getElementById('res-msg');
            if (diffType === 'neg') msgBox.innerText = "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ ‚Äî —á–∞—Å—Ç—å —É—Å–ø–µ—Ö–∞. –°–ª–µ–¥—É—é—â–∞—è –±–∏—Ç–≤–∞ –±—É–¥–µ—Ç –ª—É—á—à–µ.";
            else if (diffType === 'pos') msgBox.innerText = "–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –¢—ã —Å—Ç–∞–Ω–æ–≤–∏—à—å—Å—è —Å–∏–ª—å–Ω–µ–µ.";
            else msgBox.innerText = "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞—Å—á–∏—Ç–∞–Ω–∞. –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å ‚Äî –ø—Ä–∏–∑–Ω–∞–∫ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞.";

            showScreen('screen-result');
            tg.HapticFeedback.notificationOccurred('success');
            renderMain();
        }

        function renderMain() {
            document.getElementById('stat-xp').innerText = totalXP.toLocaleString();
            document.getElementById('stat-count').innerText = history.length;
            updateCharacter();

            const curListDiv = document.getElementById('current-list');
            const curBlock = document.getElementById('current-session-block');
            
            if (currentSession.length > 0) {
                curBlock.classList.remove('hidden');
                let curXP = currentSession.reduce((a,c)=>a+c.xp,0);
                document.getElementById('session-title').innerText = `–°–µ–π—á–∞—Å: +${curXP} XP`;
                
                curListDiv.innerHTML = currentSession.map(s => `
                    <div class="list-item">
                        <div>
                            <b>${s.name}</b>
                            <div style="font-size:12px; opacity:0.7">
                                ${s.type === 3 ? s.r + ' –º–∏–Ω' : 
                                  s.type === 2 ? s.r + ' —Å–µ–∫' : 
                                  (s.w > 0 ? s.w + '–∫–≥ √ó ' : (s.type===1?'–°–≤–æ–π –≤–µ—Å √ó ':'')) + s.r}
                            </div>
                        </div>
                        <div style="text-align:right; display:flex; align-items:center;">
                            <div>
                                <span style="color:var(--gold); font-weight:bold; font-size:13px;">+${s.xp}</span><br>
                                <span style="font-size:10px; opacity:0.5">${s.kcal} –∫–∫–∞–ª</span>
                            </div>
                            <div class="del-btn" onclick="deleteSet(${s.id})">‚úï</div>
                        </div>
                    </div>
                `).join('');
            } else {
                curBlock.classList.add('hidden');
            }

            const hList = document.getElementById('history-list');
            hList.innerHTML = history.slice(0, 3).map(h => `
                <div class="list-item" style="font-size: 13px;">
                    <div style="opacity: 0.8">
                        <div>${h.dateStr}</div>
                        <div style="font-size:10px; color:var(--tg-hint)">${h.isCardio ? '–ö–∞—Ä–¥–∏–æ' : '–°–∏–ª–æ–≤–∞—è'}</div>
                    </div>
                    <div style="text-align:right">
                        ${!h.isCardio ? 'üèãÔ∏è ' + h.vol + ' –∫–≥' : 'üèÉ ' + h.kcal + ' –∫–∫–∞–ª'} 
                        <span style="color:var(--gold); margin-left:8px; font-weight:bold">+${h.xp} XP</span>
                    </div>
                </div>
            `).join('') || '<div style="text-align:center; font-size:12px; opacity:0.5; padding:10px;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞. –¢–≤–æ–π –ø—É—Ç—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è!</div>';
        }

        function updateCharacter() {
            let current = LEVELS[0];
            let next = LEVELS[1];
            for (let i = 0; i < LEVELS.length; i++) {
                if (totalXP >= LEVELS[i].xp) {
                    current = LEVELS[i];
                    next = LEVELS[i+1] || { xp: totalXP * 1.5, rank: "–ú–∞–∫—Å–∏–º—É–º" };
                }
            }
            document.getElementById('main-char-icon').innerText = current.icon;
            document.getElementById('main-char-rank').innerText = current.rank;
            document.getElementById('stat-lvl').innerText = LEVELS.indexOf(current) + 1;
            document.getElementById('main-char-xp').innerText = `${totalXP} XP`;
            document.getElementById('main-char-next').innerText = `–¶–µ–ª—å: ${next.xp}`;
            const percent = Math.min(100, Math.max(0, ((totalXP - current.xp) / (next.xp - current.xp)) * 100));
            document.getElementById('xp-fill').style.width = percent + "%";
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById(id).classList.add('active-screen');
            window.scrollTo(0,0);
        }
        
        function closeResult() {
            showScreen('screen-main');
        }

        function safeReset() {
            if (confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.")) {
                localStorage.clear();
                profile = null;
                history = [];
                totalXP = 0;
                location.reload();
            }
        }

        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', function() {
            if (currentSession.length > 0) localStorage.setItem('ip_current', JSON.stringify(currentSession));
            localStorage.setItem('ip_history', JSON.stringify(history));
            localStorage.setItem('ip_xp', totalXP);
        });

    </script>
</body>
</html>