<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>IronPath - Gold Master</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { 
            --tg-bg: var(--tg-theme-bg-color, #121212);
            --tg-text: var(--tg-theme-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #9ca3af);
            --tg-link: var(--tg-theme-link-color, #3b82f6);
            --tg-btn: var(--tg-theme-button-color, #3b82f6);
            --tg-btn-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary: var(--tg-theme-secondary-bg-color, #1f2937);
            
            --green: #10b981;
            --red: #ef4444;
            --gold: #f59e0b;
            --purple: #8b5cf6;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--tg-bg); color: var(--tg-text); 
            margin: 0; padding: 16px; max-width: 600px; margin: 0 auto; 
            -webkit-tap-highlight-color: transparent; touch-action: manipulation;
        }

        .screen { display: none; animation: fade 0.3s ease-out; }
        .active-screen { display: block; }
        @keyframes fade { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .card { 
            background: var(--tg-secondary); padding: 20px; 
            border-radius: 20px; margin-bottom: 16px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        h1, h2, h3 { margin: 0 0 10px 0; font-weight: 800; letter-spacing: -0.5px; }
        p { color: var(--tg-hint); font-size: 14px; line-height: 1.5; margin-bottom: 15px; }

        .btn { 
            width: 100%; padding: 14px; border: none; border-radius: 14px; 
            font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-primary { background: var(--tg-btn); color: var(--tg-btn-text); }
        .btn-success { background: var(--green); color: #fff; }
        .btn-outline { background: transparent; border: 1px solid var(--tg-hint); color: var(--tg-hint); font-size: 13px; }
        .btn:active { transform: scale(0.98); opacity: 0.9; }

        input, select { 
            width: 100%; padding: 14px; margin-bottom: 12px; 
            background: var(--tg-bg); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; 
            color: var(--tg-text); font-size: 16px; box-sizing: border-box; outline: none;
            -webkit-appearance: none;
        }
        input:focus { border-color: var(--tg-link); }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; text-align: center; }
        .stat-val { font-size: 20px; font-weight: 800; color: var(--tg-link); }
        .stat-label { font-size: 10px; text-transform: uppercase; color: var(--tg-hint); margin-top: 4px; }

        .char-container { text-align: center; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 15px; }
        .char-icon { font-size: 72px; display: block; margin-bottom: 5px; animation: bounce 3s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        
        .xp-bar-bg { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-top: 8px; overflow: hidden; }
        .xp-bar-fill { height: 100%; background: linear-gradient(90deg, var(--tg-link), var(--purple)); width: 0%; transition: width 0.5s; }

        .list-item { 
            padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); 
            display: flex; justify-content: space-between; align-items: center;
        }
        .del-btn { 
            color: var(--red); padding: 6px 10px; font-size: 14px; cursor: pointer; 
            background: rgba(239, 68, 68, 0.1); border-radius: 8px; margin-left: 10px;
        }

        .diff-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-top: 5px; background: rgba(255,255,255,0.1);}
        .diff-pos { background: rgba(16, 185, 129, 0.2); color: var(--green); }
        .diff-neg { background: rgba(239, 68, 68, 0.2); color: var(--red); }
        
        .hint-block {
            color: var(--gold); font-size: 12px; margin: 10px 0;
            background: rgba(245, 158, 11, 0.1); padding: 10px;
            border-radius: 8px; border-left: 3px solid var(--gold); display: none;
        }
        .hint-block.visible { display: block; }
        .hidden { display: none !important; }
        .input-row { display: flex; gap: 10px; }
        .input-group { flex: 1; }
        .input-label { font-size: 11px; color: var(--tg-hint); margin-bottom: 4px; display: block; }
    </style>
</head>
<body>

    <div id="screen-onboarding" class="screen">
        <div class="card" style="text-align: center; padding-top: 40px; min-height: 300px; display: flex; flex-direction: column; justify-content: space-between;">
            <div>
                <div style="font-size: 70px; margin-bottom: 20px;">üõ°Ô∏è</div>
                <h2>–ü—É—Ç—å –ñ–µ–ª–µ–∑–∞</h2>
                <p>–¢–≤–æ–π –ª–∏—á–Ω—ã–π RPG-–¥–Ω–µ–≤–Ω–∏–∫.</p>
                <p>–ó–¥–µ—Å—å –Ω–µ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª. –ö–∞–∂–¥–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ ‚Äî —ç—Ç–æ –æ–ø—ã—Ç. –ö–∞–∂–¥–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ‚Äî —É—Ä–æ–≤–µ–Ω—å.</p>
            </div>
            <button class="btn btn-primary" onclick="showScreen('screen-profile')">–ù–∞—á–∞—Ç—å –ø—É—Ç—å</button>
        </div>
    </div>

    <div id="screen-profile" class="screen">
        <div class="card">
            <h2>–ü–∞—Å–ø–æ—Ä—Ç –∞—Ç–ª–µ—Ç–∞</h2>
            <div class="input-row">
                <div class="input-group">
                    <label class="input-label">–í–µ—Å (–∫–≥)</label>
                    <input type="number" id="prof-weight" placeholder="80" inputmode="decimal">
                </div>
                <div class="input-group">
                    <label class="input-label">–†–æ—Å—Ç (—Å–º)</label>
                    <input type="number" id="prof-height" placeholder="175" inputmode="numeric">
                </div>
            </div>
            <div class="input-row">
                <div class="input-group">
                    <label class="input-label">–í–æ–∑—Ä–∞—Å—Ç</label>
                    <input type="number" id="prof-age" placeholder="25" inputmode="numeric">
                </div>
                <div class="input-group">
                    <label class="input-label">–ü–æ–ª</label>
                    <select id="prof-gender">
                        <option value="male">–ú—É–∂—á–∏–Ω–∞</option>
                        <option value="female">–ñ–µ–Ω—â–∏–Ω–∞</option>
                    </select>
                </div>
            </div>
            <label class="input-label">–¶–µ–ª—å</label>
            <select id="prof-goal">
                <option value="strength">–°–∏–ª–∞ (–ü–∞—É—ç—Ä–ª–∏—Ñ—Ç–∏–Ω–≥) üí™</option>
                <option value="muscle">–ì–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è (–ú–∞—Å—Å–∞) üèãÔ∏è</option>
                <option value="health">–ó–¥–æ—Ä–æ–≤—å–µ –∏ –¢–æ–Ω—É—Å ü´Ä</option>
                <option value="fatloss">–†–µ–ª—å–µ—Ñ / –ü–æ—Ö—É–¥–µ–Ω–∏–µ üî•</option>
            </select>
            <button class="btn btn-primary" style="margin-top: 10px;" onclick="saveProfile()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>

    <div id="screen-main" class="screen">
        <div class="card">
            <div class="char-container">
                <span class="char-icon" id="main-char-icon">üê£</span>
                <div style="font-weight: bold; font-size: 18px;" id="main-char-rank">–ù–æ–≤–∏—á–æ–∫</div>
                <div class="xp-bar-bg"><div class="xp-bar-fill" id="xp-fill"></div></div>
                <div style="display:flex; justify-content:space-between; font-size: 11px; color: var(--tg-hint); margin-top: 5px;">
                    <span id="main-char-xp">0 XP</span>
                    <span id="main-char-next">–¶–µ–ª—å: 100</span>
                </div>
            </div>
            <div class="stat-grid">
                <div><div class="stat-val" id="stat-xp">0</div><div class="stat-label">–í—Å–µ–≥–æ XP</div></div>
                <div><div class="stat-val" id="stat-count">0</div><div class="stat-label">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div></div>
                <div><div class="stat-val" id="stat-lvl">1</div><div class="stat-label">–£—Ä–æ–≤–µ–Ω—å</div></div>
            </div>
        </div>

        <div class="card">
            <h3>–ó–∞–ø–∏—Å—å –ø–æ–¥—Ö–æ–¥–∞</h3>
            <select id="select-cat" onchange="updateExList()">
                <option value="chest">–ì—Ä—É–¥—å</option>
                <option value="back">–°–ø–∏–Ω–∞</option>
                <option value="legs">–ù–æ–≥–∏</option>
                <option value="shoulders">–ü–ª–µ—á–∏</option>
                <option value="arms">–†—É–∫–∏</option>
                <option value="abs">–ü—Ä–µ—Å—Å / –ö–æ—Ä</option>
                <option value="cardio">–ö–∞—Ä–¥–∏–æ</option>
            </select>
            <select id="select-ex" onchange="adaptInputs()"></select>
            
            <div id="hints-container">
                <div id="hint-unilateral" class="hint-block">ü¶µ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –Ω–∞ –æ–¥–Ω—É —Å—Ç–æ—Ä–æ–Ω—É. –í–≤–æ–¥–∏ –ø–æ–≤—Ç–æ—Ä—ã –¥–ª—è –æ–¥–Ω–æ–π –Ω–æ–≥–∏/—Ä—É–∫–∏.</div>
                <div id="hint-dumbbell" class="hint-block">üèãÔ∏è‚Äç‚ôÇÔ∏è –í–≤–æ–¥–∏ –≤–µ—Å –æ–¥–Ω–æ–π –≥–∞–Ω—Ç–µ–ª–∏. –°–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ —É–¥–≤–æ–∏—Ç —Ç–æ–Ω–Ω–∞–∂.</div>
                <div id="hint-bodyweight" class="hint-block">‚öñÔ∏è –°–≤–æ–π –≤–µ—Å. –£–∫–∞–∂–∏ –¥–æ–ø. –≤–µ—Å (–∏–ª–∏ 0).</div>
            </div>

            <div id="input-container-strength" class="input-row">
                <div class="input-group">
                    <label id="label-w" class="input-label">–í–µ—Å (–∫–≥)</label>
                    <input type="number" id="input-w" inputmode="decimal">
                </div>
                <div class="input-group">
                    <label id="label-r" class="input-label">–ü–æ–≤—Ç–æ—Ä—ã</label>
                    <input type="number" id="input-r" inputmode="numeric">
                </div>
            </div>

            <div id="input-container-cardio" class="hidden">
                <label class="input-label">–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å</label>
                <select id="input-cardio-intensity"></select>
                <label class="input-label">–í—Ä–µ–º—è (–º–∏–Ω—É—Ç—ã)</label>
                <input type="number" id="input-cardio-time" placeholder="–ú–∏–Ω" inputmode="numeric">
            </div>

            <button class="btn btn-primary" style="margin-top:12px;" onclick="addSet()">–ó–∞–ø–∏—Å–∞—Ç—å</button>
        </div>

        <div id="current-session-block" class="card hidden">
            <h3 id="session-title">–°–µ–π—á–∞—Å: 0 XP</h3>
            <div id="current-list"></div>
            <button class="btn btn-success" style="margin-top: 15px;" onclick="finishWorkout()">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
        </div>

        <div class="card">
            <h3 style="font-size:14px; opacity:0.7">–ò—Å—Ç–æ—Ä–∏—è –±–∏—Ç–≤</h3>
            <div id="history-list" style="max-height: 300px; overflow-y: auto;"></div>
            <button class="btn btn-outline" style="border-color: var(--red); color: var(--red); margin-top:15px; width:100%" onclick="safeReset()">üß® –°–±—Ä–æ—Å –≤—Å–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</button>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <div class="card" style="text-align: center;">
            <div style="font-size: 60px; margin-bottom: 10px;">üèÜ</div>
            <h2 id="res-title">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
            <div id="res-diff-badge" class="diff-badge hidden"></div>
            
            <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin: 20px 0;">
                <div style="font-size: 12px; opacity: 0.7;">–ü–æ–ª—É—á–µ–Ω–æ –æ–ø—ã—Ç–∞</div>
                <div style="font-size: 42px; font-weight: 900; color: var(--gold);" id="res-xp">+0 XP</div>
            </div>

            <div class="stat-grid">
                <div><div class="stat-val" id="res-vol">0</div><div class="stat-label">–û–±—ä–µ–º</div></div>
                <div><div class="stat-val" id="res-kcal">0</div><div class="stat-label">–ö–∫–∞–ª</div></div>
                <div><div class="stat-val" id="res-time">0</div><div class="stat-label">–ú–∏–Ω</div></div>
            </div>

            <div id="res-msg" style="margin: 15px 0; font-size: 14px; font-style: italic; color: var(--tg-hint);"></div>
            <div id="res-tip" class="hint-block" style="display:block; text-align: left; margin-top: 15px; background: rgba(59, 130, 246, 0.1); border-color: var(--tg-link); color: var(--tg-text);"></div>
            
            <button class="btn btn-primary" style="margin-top: 20px;" onclick="closeResult()">–í –º–µ–Ω—é</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // 1 - –ë–∞–∑–∞ (–°–≤–æ–π –≤–µ—Å), 2 - –°—Ç–∞—Ç–∏–∫–∞ (—Å–µ–∫), 0 - –û–±—ã—á–Ω–æ–µ
        const EX_DB = {
            legs: [
                ["–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è (–®—Ç–∞–Ω–≥–∞)", 6.0, 0, 1], ["–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è (–ì–∞–Ω—Ç–µ–ª—å/–ö—É–±–æ–∫)", 5.5, 0, 2],
                ["–ñ–∏–º –Ω–æ–≥–∞–º–∏", 5.0, 0, 1], ["–°—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞", 7.0, 0, 1], ["–†—É–º—ã–Ω—Å–∫–∞—è —Ç—è–≥–∞", 6.0, 0, 1],
                ["–í—ã–ø–∞–¥—ã (–ì–∞–Ω—Ç–µ–ª–∏)", 5.5, 0, 2], ["–í—ã–ø–∞–¥—ã (–°–≤–æ–π –≤–µ—Å)", 4.5, 1, 0],
                ["–ë–æ–ª–≥–∞—Ä—Å–∫–∏–µ –ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è", 6.5, 0, 2], ["–†–∞–∑–≥–∏–±–∞–Ω–∏–µ –Ω–æ–≥", 3.5, 0, 1], ["–°–≥–∏–±–∞–Ω–∏–µ –Ω–æ–≥", 3.5, 0, 1]
            ],
            back: [
                ["–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è", 5.0, 1, 0], ["–¢—è–≥–∞ —à—Ç–∞–Ω–≥–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ", 6.0, 0, 1],
                ["–¢—è–≥–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞", 4.0, 0, 1], ["–¢—è–≥–∞ –Ω–∏–∂–Ω–µ–≥–æ –±–ª–æ–∫–∞", 4.0, 0, 1],
                ["–¢—è–≥–∞ –≥–∞–Ω—Ç–µ–ª–∏ (–æ–¥–Ω–æ–π —Ä—É–∫–æ–π)", 4.5, 0, 2], ["–ì–∏–ø–µ—Ä—ç–∫—Å—Ç–µ–Ω–∑–∏—è", 3.5, 1, 0], ["–ü—É–ª–æ–≤–µ—Ä", 3.5, 0, 1]
            ],
            chest: [
                ["–ñ–∏–º –ª–µ–∂–∞ (–®—Ç–∞–Ω–≥–∞)", 5.5, 0, 1], ["–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –ª–µ–∂–∞", 5.5, 0, 2],
                ["–ñ–∏–º –ø–æ–¥ —É–≥–ª–æ–º (–®—Ç–∞–Ω–≥–∞)", 5.5, 0, 1], ["–ñ–∏–º –ø–æ–¥ —É–≥–ª–æ–º (–ì–∞–Ω—Ç–µ–ª–∏)", 5.5, 0, 2],
                ["–û—Ç–∂–∏–º–∞–Ω–∏—è", 4.0, 1, 0], ["–ë—Ä—É—Å—å—è", 5.0, 1, 0], ["–ë–∞–±–æ—á–∫–∞", 3.0, 0, 1]
            ],
            shoulders: [
                ["–ê—Ä–º–µ–π—Å–∫–∏–π –∂–∏–º", 5.0, 0, 1], ["–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π —Å–∏–¥—è", 5.0, 0, 2],
                ["–ú–∞—Ö–∏ –≤ —Å—Ç–æ—Ä–æ–Ω—ã", 3.5, 0, 2], ["–ú–∞—Ö–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ", 3.5, 0, 2], ["–¢—è–≥–∞ –∫ –ª–∏—Ü—É", 3.5, 0, 1]
            ],
            arms: [
                ["–ü–æ–¥—ä–µ–º –Ω–∞ –±–∏—Ü–µ–ø—Å (–®—Ç)", 3.5, 0, 1], ["–ü–æ–¥—ä–µ–º –≥–∞–Ω—Ç–µ–ª–µ–π (–ë–∏—Ü)", 3.5, 0, 2], ["–ú–æ–ª–æ—Ç–∫–∏", 3.5, 0, 2],
                ["–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∂–∏–º", 3.5, 0, 1], ["–†–∞–∑–≥–∏–±–∞–Ω–∏–µ –Ω–∞ –±–ª–æ–∫–µ", 3.0, 0, 1]
            ],
            abs: [
                ["–°–∫—Ä—É—á–∏–≤–∞–Ω–∏—è", 3.0, 1, 0], ["–ü–æ–¥—ä–µ–º –Ω–æ–≥", 4.0, 1, 0], 
                ["–ü–ª–∞–Ω–∫–∞", 3.5, 2, 0], ["–†—É—Å—Å–∫–∏–π —Ç–≤–∏—Å—Ç", 3.5, 1, 0]
            ],
            cardio: [
                ["–ë–µ–≥", 9.0, 3, 0], ["–•–æ–¥—å–±–∞", 3.5, 3, 0], ["–≠–ª–ª–∏–ø—Å", 6.0, 3, 0],
                ["–í–µ–ª–æ—Ç—Ä–µ–Ω–∞–∂–µ—Ä", 6.0, 3, 0], ["–ì—Ä–µ–±–ª—è", 8.0, 3, 0]
            ]
        };

        const LEVELS = [
            { xp: 0, icon: "ü•ö", rank: "–Ø–π—Ü–æ" }, { xp: 500, icon: "üê£", rank: "–ù–æ–≤–∏—á–æ–∫" },
            { xp: 1500, icon: "üê•", rank: "–õ—é–±–∏—Ç–µ–ª—å" }, { xp: 4000, icon: "üêì", rank: "–ë–æ–µ—Ü" },
            { xp: 10000, icon: "üêó", rank: "–ê—Ç–ª–µ—Ç" }, { xp: 25000, icon: "ü¶ç", rank: "–ú–∞—à–∏–Ω–∞" },
            { xp: 60000, icon: "ü¶ñ", rank: "–¢–∏—Ç–∞–Ω" }, { xp: 150000, icon: "üëë", rank: "–ö–æ—Ä–æ–ª—å" }
        ];

        const TIPS = {
            strength: ["–û—Ç–¥—ã—Ö 3-5 –º–∏–Ω ‚Äî —ç—Ç–æ –Ω–µ –ª–µ–Ω—å, —ç—Ç–æ –±–∏–æ—Ö–∏–º–∏—è.", "–ë–∞–∑–∞ ‚Äî 80% —É—Å–ø–µ—Ö–∞.", "–ü—Ä–æ–≥—Ä–µ—Å—Å–∏—è –Ω–∞–≥—Ä—É–∑–æ–∫ = —Ä–æ—Å—Ç."],
            muscle: ["–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π –Ω–µ–≥–∞—Ç–∏–≤–Ω—É—é —Ñ–∞–∑—É.", "–ú—ã—à—Ü–∞ –Ω–µ –∑–Ω–∞–µ—Ç —Ü–∏—Ñ—Ä, –æ–Ω–∞ –∑–Ω–∞–µ—Ç –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ.", "–î–∏–∞–ø–∞–∑–æ–Ω 8-12 –∏–¥–µ–∞–ª–µ–Ω –¥–ª—è –æ–±—ä–µ–º–∞."],
            fatloss: ["–ü–∏—Ç–∞–Ω–∏–µ ‚Äî 80% —É—Å–ø–µ—Ö–∞.", "–°–∏–ª–æ–≤—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –º—ã—à—Ü—ã –ø—Ä–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–µ.", "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (—à–∞–≥–∏) –≤–∞–∂–Ω–µ–µ —á–∞—Å–∞ –≤ –∑–∞–ª–µ."],
            health: ["–ì–ª–∞–≤–Ω–æ–µ ‚Äî —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å.", "–†–∞–∑–º–∏–Ω–∫–∞ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ.", "–ë–æ–ª—å –≤ —Å—É—Å—Ç–∞–≤–µ ‚Äî —Å—Ç–æ–ø —Å–∏–≥–Ω–∞–ª."]
        };

        const CARDIO_INTENSITY = {
            default: { 3: "–õ–µ–≥–∫–∞—è (–†–∞–∑–º–∏–Ω–∫–∞)", 6: "–°—Ä–µ–¥–Ω—è—è (–ü–æ—Ç)", 9: "–í—ã—Å–æ–∫–∞—è (–¢—è–∂–µ–ª–æ)", 11: "–ú–∞–∫—Å–∏–º—É–º" },
            walk: { 3: "–ü—Ä–æ–≥—É–ª–∫–∞", 5: "–ë–æ–¥—Ä—ã–π —à–∞–≥", 7: "–í –≥–æ—Ä—É / –°–ø–µ—à–∫–∞" }
        };

        let profile = JSON.parse(localStorage.getItem('ip_profile'));
        let history = JSON.parse(localStorage.getItem('ip_history')) || [];
        let currentSession = JSON.parse(localStorage.getItem('ip_current')) || [];
        let totalXP = parseInt(localStorage.getItem('ip_xp')) || 0;

        init();

        function init() {
            tg.ready();
            if (!profile) showScreen('screen-onboarding');
            else { showScreen('screen-main'); updateExList(); renderMain(); }
        }

        function updateExList() {
            const cat = document.getElementById('select-cat').value;
            const exSelect = document.getElementById('select-ex');
            exSelect.innerHTML = EX_DB[cat].map((ex, idx) => `<option value="${idx}">${ex[0]}</option>`).join('');
            adaptInputs();
        }

        function adaptInputs() {
            const cat = document.getElementById('select-cat').value;
            const exIdx = document.getElementById('select-ex').value;
            const [name, met, type, multiplier] = EX_DB[cat][exIdx];

            const strBlock = document.getElementById('input-container-strength');
            const cardioBlock = document.getElementById('input-container-cardio');
            
            document.querySelectorAll('.hint-block').forEach(el => el.classList.remove('visible'));
            document.getElementById('input-w').value = '';
            document.getElementById('input-r').value = '';

            if (type === 3) { 
                strBlock.classList.add('hidden');
                cardioBlock.classList.remove('hidden');
                const iSelect = document.getElementById('input-cardio-intensity');
                const iMap = name.includes('–•–æ–¥—å–±–∞') ? CARDIO_INTENSITY.walk : CARDIO_INTENSITY.default;
                iSelect.innerHTML = Object.entries(iMap).map(([val, txt]) => 
                    `<option value="${val}" ${val==6?'selected':''}>${txt}</option>`
                ).join('');
            } else {
                strBlock.classList.remove('hidden');
                cardioBlock.classList.add('hidden');
                
                // –£–º–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ (—Å—Ç–∞–∫–∞—é—Ç—Å—è)
                if (name.toLowerCase().includes('–≥–∞–Ω—Ç–µ–ª') || name.includes('–ú–æ–ª–æ—Ç–∫–∏')) 
                    document.getElementById('hint-dumbbell').classList.add('visible');
                
                if ((cat === 'legs' || cat === 'back') && multiplier === 2 && !name.includes('–ì–∞–Ω—Ç–µ–ª'))
                    document.getElementById('hint-unilateral').classList.add('visible');
                
                if (type === 1) document.getElementById('hint-bodyweight').classList.add('visible');

                const lW = document.getElementById('label-w');
                const lR = document.getElementById('label-r');
                lW.innerText = (type === 2 || type === 1) ? "–î–æ–ø. –≤–µ—Å (–∫–≥)" : "–í–µ—Å (–∫–≥)";
                lR.innerText = (type === 2) ? "–í—Ä–µ–º—è (—Å–µ–∫)" : "–ü–æ–≤—Ç–æ—Ä—ã";
            }
        }

        function getBMR() {
            let s = (profile.gender === 'male') ? 5 : -161;
            return 10 * profile.weight + 6.25 * profile.height - 5 * profile.age + s;
        }

        function addSet() {
            const cat = document.getElementById('select-cat').value;
            const exIdx = document.getElementById('select-ex').value;
            const [name, metBase, type, multiplier] = EX_DB[cat][exIdx];
            
            let w = 0, r = 0, kcal = 0, vol = 0, xp = 0;
            const bmrPerMin = getBMR() / 1440; 

            if (type === 3) { // –ö–∞—Ä–¥–∏–æ
                const intensity = parseFloat(document.getElementById('input-cardio-intensity').value);
                const duration = parseFloat(document.getElementById('input-cardio-time').value);
                if (!duration) return tg.showAlert("–£–∫–∞–∂–∏ –≤—Ä–µ–º—è!");
                
                // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –º–∏–Ω—É—Ç—ã –≤ —Ñ–æ—Ä–º—É–ª–µ
                kcal = (intensity * profile.weight / 60) * duration;
                xp = Math.round(kcal * 1.2);
                r = duration; 

            } else { // –°–∏–ª–æ–≤—ã–µ
                w = parseFloat(document.getElementById('input-w').value) || 0;
                r = parseFloat(document.getElementById('input-r').value);
                if (!r) return tg.showAlert("–£–∫–∞–∂–∏ –ø–æ–≤—Ç–æ—Ä—ã!");

                // –†–µ–∞–ª—å–Ω—ã–π —Ç–æ–Ω–Ω–∞–∂ ("–∂–µ–ª–µ–∑–Ω—ã–π")
                let load = w;
                if (type === 1) load = 0; 
                if (multiplier === 2) load = w * 2;
                
                // –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º (–¥–ª—è XP –∏ EPOC)
                // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —Å—Ç–∞—Ç–∏–∫–∞ —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–≤–æ–¥–∏—Ç—Å—è –∫ –ø–æ–≤—Ç–æ—Ä–∞–º (1 —Ä–µ–ø ~ 5 —Å–µ–∫)
                let bodyFactor = profile.weight * 0.7; // ~70% –≤–µ—Å–∞ —Ç–µ–ª–∞
                let virtualRepLoad = (type === 2) ? (r / 5) : r; 
                let virtualLoadWeight = load + (type === 1 || type === 2 ? bodyFactor : 0);
                
                let virtualVol = virtualLoadWeight * virtualRepLoad;
                vol = (type === 2) ? 0 : (load * r);

                // --- –ö–∞–ª–æ—Ä–∏–∏ (Gold Master Math) ---
                // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π MET: –µ—Å–ª–∏ > 20 –ø–æ–≤—Ç–æ—Ä–æ–≤, —ç—Ç–æ —É–∂–µ –∞—ç—Ä–æ–±–∏–∫–∞
                let finalMet = (r > 20) ? metBase + 1.5 : metBase;
                
                // –í—Ä–µ–º—è –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π (–≤ –º–∏–Ω—É—Ç–∞—Ö)
                let workTimeMin = (type === 2) ? (r / 60) : (r * 4.5 / 60);
                
                // –í—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞ (–≤ –º–∏–Ω—É—Ç–∞—Ö)
                let restTimeMin = (r < 6) ? 2.5 : 1.5; 
                if (type === 2) restTimeMin = 1.0; 

                // –†–∞—Å—á–µ—Ç
                // 1. –†–∞–±–æ—Ç–∞: MET * –∫–≥ * —á–∞—Å—ã -> –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ –º–∏–Ω—É—Ç—ã: (MET * –∫–≥ / 60) * –º–∏–Ω
                let workBurn = (finalMet * profile.weight / 60) * workTimeMin;
                
                // 2. –û—Ç–¥—ã—Ö: BMR/–º–∏–Ω * –º–∏–Ω—É—Ç—ã –æ—Ç–¥—ã—Ö–∞
                let restBurn = bmrPerMin * restTimeMin;
                
                // 3. EPOC (–±–æ–Ω—É—Å –∑–∞ —Ç—è–∂–µ—Å—Ç—å)
                let liftBonus = virtualVol / 200; 
                
                kcal = (workBurn + restBurn + liftBonus) * 1.05; // 5% –∑–∞–ø–∞—Å
                
                xp = Math.round((virtualVol / 30) + (kcal * 2.5));
                if (xp > 600) xp = 600; // Cap
            }

            currentSession.unshift({ id: Date.now(), name, vol, kcal: Math.round(kcal), xp, w, r, type });
            saveSession();
            tg.HapticFeedback.impactOccurred('medium');
            renderMain();
            
            if (type !== 3) {
                document.getElementById('input-w').value = '';
                document.getElementById('input-r').value = '';
            }
        }

        function finishWorkout() {
            if (currentSession.length === 0) return;

            const vol = currentSession.reduce((a, c) => a + c.vol, 0);
            const kcal = currentSession.reduce((a, c) => a + c.kcal, 0);
            let xp = currentSession.reduce((a, c) => a + c.xp, 0);
            xp = Math.min(xp, 3000); 

            // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞
            let cardioMins = 0, strengthSets = 0;
            currentSession.forEach(s => {
                if (s.type === 3) cardioMins += s.r;
                else strengthSets++;
            });

            let sessionType = 'strength'; 
            if (strengthSets === 0) sessionType = 'cardio';
            else if (cardioMins > 15 && strengthSets > 3) sessionType = 'hybrid';

            let totalTime = Math.round(cardioMins + (strengthSets * 3)); 

            // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ (–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ)
            let diffPercent = 0;
            let diffType = 'neutral';
            
            if (history.length > 0) {
                // –ò—â–µ–º –∑–∞–ø–∏—Å—å —Ç–∞–∫–æ–≥–æ –∂–µ —Ç–∏–ø–∞ (fallback –Ω–∞ strength –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π)
                const prev = history.find(h => (h.type || 'strength') === sessionType);
                if (prev) {
                    let metric = (sessionType === 'strength') ? 'vol' : 'xp'; 
                    let currVal = (sessionType === 'strength') ? vol : xp;
                    let prevVal = (sessionType === 'strength') ? prev.vol : prev.xp;
                    
                    if (prevVal > 0) {
                        diffPercent = ((currVal - prevVal) / prevVal) * 100;
                        if (diffPercent > 3) diffType = 'pos';
                        if (diffPercent < -3) diffType = 'neg';
                    }
                }
            }

            const record = {
                date: Date.now(),
                dateStr: new Date().toLocaleDateString('ru-RU', {day:'numeric', month:'short'}),
                vol, kcal, xp, time: totalTime, type: sessionType
            };
            
            history.unshift(record);
            totalXP += xp;
            
            localStorage.setItem('ip_history', JSON.stringify(history));
            localStorage.setItem('ip_xp', totalXP);
            localStorage.removeItem('ip_current');
            currentSession = [];

            // UI –†–µ–∑—É–ª—å—Ç–∞—Ç
            document.getElementById('res-xp').innerText = `+${xp} XP`;
            // –£–ª—É—á—à–µ–Ω–Ω—ã–π –¥–∏—Å–ø–ª–µ–π –æ–±—ä–µ–º–∞
            let volDisplay = vol;
            if (sessionType === 'cardio') volDisplay = "–ö–∞—Ä–¥–∏–æ";
            else if (vol === 0 && sessionType === 'strength') volDisplay = "–°—Ç–∞—Ç–∏–∫–∞";
            document.getElementById('res-vol').innerText = volDisplay;
            
            document.getElementById('res-kcal').innerText = Math.round(kcal);
            document.getElementById('res-time').innerText = totalTime;
            
            const tipsArr = TIPS[profile.goal] || TIPS['health'];
            document.getElementById('res-tip').innerHTML = "üí° <b>–°–æ–≤–µ—Ç:</b> " + tipsArr[Math.floor(Math.random() * tipsArr.length)];

            const badge = document.getElementById('res-diff-badge');
            badge.className = 'diff-badge hidden';
            if (diffType !== 'neutral') {
                badge.classList.remove('hidden');
                badge.classList.add(diffType === 'pos' ? 'diff-pos' : 'diff-neg');
                badge.innerText = (diffType === 'pos' ? '‚ñ≤' : '‚ñº') + ` ${Math.abs(diffPercent).toFixed(1)}% (${sessionType})`;
            }

            document.getElementById('res-msg').innerText = diffType === 'neg' 
                ? "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∞–∂–Ω–æ. –í —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –ø–æ—Ä–≤—ë–º!" 
                : "–û—Ç–ª–∏—á–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å! –¢—ã —Å—Ç–∞–Ω–æ–≤–∏—à—å—Å—è —Å–∏–ª—å–Ω–µ–µ.";

            showScreen('screen-result');
            tg.HapticFeedback.notificationOccurred('success');
            renderMain();
        }

        // --- –£–¢–ò–õ–ò–¢–´ ---
        function deleteSet(id) {
            currentSession = currentSession.filter(s => s.id !== id);
            saveSession();
            renderMain();
        }
        
        function deleteHistoryItem(index) {
            if(confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∏ –ø–æ—Ç–µ—Ä—è—Ç—å XP?")) {
                const item = history[index];
                if (item.xp) totalXP = Math.max(0, totalXP - item.xp);
                
                history.splice(index, 1);
                localStorage.setItem('ip_history', JSON.stringify(history));
                localStorage.setItem('ip_xp', totalXP);
                renderMain();
            }
        }

        function saveSession() { localStorage.setItem('ip_current', JSON.stringify(currentSession)); }
        function saveProfile() {
            const w = parseFloat(document.getElementById('prof-weight').value);
            const h = parseFloat(document.getElementById('prof-height').value);
            const a = parseFloat(document.getElementById('prof-age').value);
            if (!w || !h || !a) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!");
            profile = { weight: w, height: h, age: a, gender: document.getElementById('prof-gender').value, goal: document.getElementById('prof-goal').value };
            localStorage.setItem('ip_profile', JSON.stringify(profile));
            showScreen('screen-main'); updateExList(); renderMain();
        }

        function renderMain() {
            document.getElementById('stat-xp').innerText = totalXP.toLocaleString();
            document.getElementById('stat-count').innerText = history.length;
            updateCharacter();

            const curBlock = document.getElementById('current-session-block');
            if (currentSession.length > 0) {
                curBlock.classList.remove('hidden');
                let curXP = currentSession.reduce((a,c)=>a+c.xp,0);
                document.getElementById('session-title').innerText = `–°–µ–π—á–∞—Å: +${curXP} XP`;
                document.getElementById('current-list').innerHTML = currentSession.map(s => `
                    <div class="list-item">
                        <div><b>${s.name}</b><div style="font-size:12px; opacity:0.7">${s.type===3?s.r+' –º–∏–Ω':(s.type===2?s.r+' —Å–µ–∫':(s.w>0?s.w+'–∫–≥ √ó ':'')+s.r)}</div></div>
                        <div style="text-align:right">
                            <span style="color:var(--gold); font-weight:bold">+${s.xp}</span><br><span style="font-size:10px; opacity:0.5">${s.kcal} –∫–∫–∞–ª</span>
                            <span class="del-btn" onclick="deleteSet(${s.id})">‚úï</span>
                        </div>
                    </div>`).join('');
            } else { curBlock.classList.add('hidden'); }

            document.getElementById('history-list').innerHTML = history.map((h, i) => {
                // –ö—Ä–∞—Å–∏–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏–∏
                let desc = '';
                if (h.type === 'cardio') desc = `üèÉ ${h.kcal} –∫–∫–∞–ª`;
                else if (h.vol === 0) desc = `üßò –°—Ç–∞—Ç–∏–∫–∞`; // –î–ª—è –ø–ª–∞–Ω–æ–∫
                else desc = `üèãÔ∏è ${h.vol} –∫–≥`;

                return `
                <div class="list-item">
                    <div style="opacity:0.8"><div>${h.dateStr}</div><div style="font-size:10px; color:var(--tg-hint)">${(h.type||'strength').toUpperCase()}</div></div>
                    <div style="text-align:right; display:flex; align-items:center">
                        <div style="margin-right:10px">${desc} <span style="color:var(--gold)">+${h.xp}</span></div>
                        <div class="del-btn" onclick="deleteHistoryItem(${i})">‚úï</div>
                    </div>
                </div>`
            }).join('') || '<div style="text-align:center; opacity:0.5; padding:20px">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–∞—á–Ω–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É!</div>';
        }

        function updateCharacter() {
            let current = LEVELS[0], next = LEVELS[1];
            for (let i = 0; i < LEVELS.length; i++) {
                if (totalXP >= LEVELS[i].xp) { current = LEVELS[i]; next = LEVELS[i+1] || { xp: totalXP*1.5, rank: "–ú–∞–∫—Å–∏–º—É–º" }; }
            }
            document.getElementById('main-char-icon').innerText = current.icon;
            document.getElementById('main-char-rank').innerText = current.rank;
            document.getElementById('stat-lvl').innerText = LEVELS.indexOf(current) + 1;
            document.getElementById('main-char-xp').innerText = `${totalXP} XP`;
            document.getElementById('main-char-next').innerText = `–¶–µ–ª—å: ${next.xp}`;
            document.getElementById('xp-fill').style.width = Math.min(100, ((totalXP - current.xp)/(next.xp - current.xp))*100) + "%";
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById(id).classList.add('active-screen');
            window.scrollTo(0,0);
        }
        function closeResult() { showScreen('screen-main'); }
        function safeReset() {
            if (confirm("–£–¥–∞–ª–∏—Ç—å –∞–±—Å–æ–ª—é—Ç–Ω–æ –≤—Å—ë? –≠—Ç–æ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.")) { localStorage.clear(); location.reload(); }
        }
        window.addEventListener('beforeunload', function() {
            if (currentSession.length > 0) localStorage.setItem('ip_current', JSON.stringify(currentSession));
        });
    </script>
</body>
</html>