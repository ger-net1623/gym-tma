<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>IronPath</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { 
            --tg-bg: var(--tg-theme-bg-color, #121212);
            --tg-text: var(--tg-theme-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #9ca3af);
            --tg-link: var(--tg-theme-link-color, #3b82f6);
            --tg-btn: var(--tg-theme-button-color, #3b82f6);
            --tg-btn-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary: var(--tg-theme-secondary-bg-color, #1f2937);
            
            --green: #10b981;
            --red: #ef4444;
            --gold: #f59e0b;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--tg-bg); color: var(--tg-text); 
            margin: 0; padding: 16px; max-width: 600px; margin: 0 auto; 
            -webkit-tap-highlight-color: transparent; touch-action: manipulation;
        }

        .screen { display: none; animation: fade 0.2s ease-out; }
        .active-screen { display: block; }
        @keyframes fade { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .card { 
            background: var(--tg-secondary); padding: 20px; 
            border-radius: 20px; margin-bottom: 16px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        h2, h3 { margin: 0 0 10px 0; font-weight: 800; letter-spacing: -0.5px; }
        p { color: var(--tg-hint); font-size: 14px; margin-bottom: 15px; }

        .btn { 
            width: 100%; padding: 14px; border: none; border-radius: 14px; 
            font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-primary { background: var(--tg-btn); color: var(--tg-btn-text); }
        .btn-success { background: var(--green); color: #fff; }
        .btn-outline { background: transparent; border: 1px solid var(--tg-hint); color: var(--tg-hint); font-size: 13px; }
        .btn:active { transform: scale(0.98); opacity: 0.9; }

        input, select { 
            width: 100%; padding: 14px; margin-bottom: 12px; 
            background: var(--tg-bg); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; 
            color: var(--tg-text); font-size: 16px; box-sizing: border-box; outline: none;
            appearance: none; -webkit-appearance: none;
        }
        input:focus { border-color: var(--tg-link); }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; text-align: center; }
        .stat-val { font-size: 20px; font-weight: 800; color: var(--tg-link); }
        .stat-label { font-size: 10px; text-transform: uppercase; color: var(--tg-hint); margin-top: 4px; }

        .char-container { text-align: center; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 15px; }
        .char-icon { font-size: 72px; display: block; margin-bottom: 5px; animation: bounce 3s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        
        .xp-bar-bg { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-top: 8px; overflow: hidden; }
        .xp-bar-fill { height: 100%; background: linear-gradient(90deg, var(--tg-link), var(--gold)); width: 0%; transition: width 0.5s; }

        .list-item { 
            padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); 
            display: flex; justify-content: space-between; align-items: center;
        }
        .del-btn { 
            color: var(--red); padding: 8px 12px; font-size: 18px; cursor: pointer; 
            background: rgba(239, 68, 68, 0.1); border-radius: 8px; margin-left: 10px;
            display: flex; align-items: center; justify-content: center;
            height: 32px; width: 32px;
        }

        .diff-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-top: 5px; background: rgba(255,255,255,0.1);}
        .diff-pos { background: rgba(16, 185, 129, 0.2); color: var(--green); }
        .diff-neg { background: rgba(239, 68, 68, 0.2); color: var(--red); }
        
        .hint-block {
            color: var(--gold); font-size: 12px; margin: 10px 0;
            background: rgba(245, 158, 11, 0.1); padding: 10px;
            border-radius: 8px; border-left: 3px solid var(--gold); display: none;
        }
        .hint-block.visible { display: block; }
        .hidden { display: none !important; }
        .input-row { display: flex; gap: 10px; }
        .input-group { flex: 1; }
        .input-label { font-size: 11px; color: var(--tg-hint); margin-bottom: 4px; display: flex; justify-content: space-between; }
        
        .pr-badge { color: var(--gold); font-weight: bold; font-size: 11px; animation: pulse 2s infinite; display: none; }
        .pr-badge.visible { display: inline; }
        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }
        
        #toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--gold); color: #000; padding: 10px 20px; border-radius: 20px;
            font-weight: bold; z-index: 1000; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

    <div id="toast">üèÜ –ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥!</div>

    <div id="screen-onboarding" class="screen">
        <div class="card" style="text-align: center; padding-top: 40px; min-height: 300px; display: flex; flex-direction: column; justify-content: space-between;">
            <div>
                <div style="font-size: 70px; margin-bottom: 20px;">üõ°Ô∏è</div>
                <h2>IronPath</h2>
                <p>–§–∏–∫—Å–∏—Ä—É–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.<br>–ü—Ä–æ–∫–∞—á–∏–≤–∞–π –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.<br>–°–ª–µ–¥–∏ –∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º.</p>
            </div>
            <button class="btn btn-primary" onclick="showScreen('screen-profile')">–ù–∞—á–∞—Ç—å</button>
        </div>
    </div>

    <div id="screen-profile" class="screen">
        <div class="card">
            <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
            <p>–ù—É–∂–Ω–æ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∫–∞–ª–æ—Ä–∏–π –∏ XP</p>
            <div class="input-row">
                <div class="input-group">
                    <label class="input-label">–í–µ—Å (–∫–≥)</label>
                    <input type="number" id="prof-weight" placeholder="80" inputmode="decimal">
                </div>
                <div class="input-group">
                    <label class="input-label">–†–æ—Å—Ç (—Å–º)</label>
                    <input type="number" id="prof-height" placeholder="175" inputmode="numeric">
                </div>
            </div>
            <div class="input-row">
                <div class="input-group">
                    <label class="input-label">–í–æ–∑—Ä–∞—Å—Ç</label>
                    <input type="number" id="prof-age" placeholder="25" inputmode="numeric">
                </div>
                <div class="input-group">
                    <label class="input-label">–ü–æ–ª</label>
                    <select id="prof-gender">
                        <option value="male">–ú—É–∂—á–∏–Ω–∞</option>
                        <option value="female">–ñ–µ–Ω—â–∏–Ω–∞</option>
                    </select>
                </div>
            </div>
            <label class="input-label">–¶–µ–ª—å</label>
            <select id="prof-goal">
                <option value="strength">–°–∏–ª–∞</option>
                <option value="muscle">–ú–∞—Å—Å–∞</option>
                <option value="health">–ó–¥–æ—Ä–æ–≤—å–µ</option>
                <option value="fatloss">–ü–æ—Ö—É–¥–µ–Ω–∏–µ</option>
            </select>
            <button class="btn btn-primary" style="margin-top: 10px;" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <div id="screen-main" class="screen">
        <div class="card">
            <div class="char-container">
                <span class="char-icon" id="main-char-icon">üê£</span>
                <div style="font-weight: bold; font-size: 18px;" id="main-char-rank">–ù–æ–≤–∏—á–æ–∫</div>
                <div class="xp-bar-bg"><div class="xp-bar-fill" id="xp-fill"></div></div>
                <div style="display:flex; justify-content:space-between; font-size: 11px; color: var(--tg-hint); margin-top: 5px;">
                    <span id="main-char-xp">0 XP</span>
                    <span id="main-char-next">–¶–µ–ª—å: 500</span>
                </div>
            </div>
            <div class="stat-grid">
                <div><div class="stat-val" id="stat-xp">0</div><div class="stat-label">–í—Å–µ–≥–æ XP</div></div>
                <div><div class="stat-val" id="stat-count">0</div><div class="stat-label">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div></div>
                <div><div class="stat-val" id="stat-lvl">1</div><div class="stat-label">–£—Ä–æ–≤–µ–Ω—å</div></div>
            </div>
        </div>

        <div class="card">
            <h3>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3>
            <select id="select-cat" onchange="updateExList()">
                <option value="chest">–ì—Ä—É–¥—å</option>
                <option value="back">–°–ø–∏–Ω–∞</option>
                <option value="legs">–ù–æ–≥–∏</option>
                <option value="shoulders">–ü–ª–µ—á–∏</option>
                <option value="arms">–†—É–∫–∏</option>
                <option value="abs">–ü—Ä–µ—Å—Å / –ö–æ—Ä</option>
                <option value="cardio">–ö–∞—Ä–¥–∏–æ</option>
            </select>
            
            <select id="select-ex" onchange="adaptInputs()"></select>
            
            <div id="hints-container">
                <div id="hint-unilateral" class="hint-block">ü¶µ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –Ω–∞ –æ–¥–Ω—É —Å—Ç–æ—Ä–æ–Ω—É. –í–≤–æ–¥–∏ –ø–æ–≤—Ç–æ—Ä—ã –¥–ª—è –æ–¥–Ω–æ–π –Ω–æ–≥–∏/—Ä—É–∫–∏.</div>
                <div id="hint-dumbbell" class="hint-block">üèãÔ∏è‚Äç‚ôÇÔ∏è –í–≤–æ–¥–∏ –≤–µ—Å –æ–¥–Ω–æ–π –≥–∞–Ω—Ç–µ–ª–∏. –ú—ã —É—á—Ç–µ–º –æ–±—â–∏–π –æ–±—ä–µ–º.</div>
                <div id="hint-bodyweight" class="hint-block">‚öñÔ∏è –°–≤–æ–π –≤–µ—Å —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è! –í –ø–æ–ª–µ –≤–≤–µ–¥–∏ 0 –∏–ª–∏ –¥–æ–ø. –≤–µ—Å.</div>
                <div id="hint-machine" class="hint-block">ü§ñ –¢—Ä–µ–Ω–∞–∂–µ—Ä. –í–µ—Å —Ç–µ–ª–∞ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –º–µ—Ö–∞–Ω–∏–∫—É.</div>
                <div id="hint-facepull" class="hint-block">üß∂ –û–±—ã—á–Ω–æ –¥–µ–ª–∞–µ—Ç—Å—è –≤ –±–ª–æ–∫–µ (–∫–∞–Ω–∞—Ç–∫–∞).</div>
            </div>

            <div id="input-container-strength" class="input-row">
                <div class="input-group">
                    <label id="label-w" class="input-label">
                        <span id="text-w-label">–í–µ—Å (–∫–≥)</span>
                        <span id="pr-display" class="pr-badge"></span>
                    </label>
                    <input type="number" id="input-w" inputmode="decimal">
                </div>
                <div class="input-group">
                    <label id="label-r" class="input-label">–ü–æ–≤—Ç–æ—Ä—ã</label>
                    <input type="number" id="input-r" inputmode="numeric">
                </div>
            </div>

            <div id="input-container-cardio" class="hidden">
                <div class="input-group">
                    <label class="input-label">–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å</label>
                    <select id="input-cardio-intensity"></select>
                </div>
                <div class="input-group">
                    <label class="input-label">–í—Ä–µ–º—è (–º–∏–Ω)</label>
                    <input type="number" id="input-cardio-time" placeholder="–ú–∏–Ω" inputmode="numeric">
                </div>
            </div>

            <button class="btn btn-primary" style="margin-top:12px;" onclick="addSet()">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥</button>
        </div>

        <div id="current-session-block" class="card hidden">
            <h3 id="session-title">–°–µ–π—á–∞—Å: 0 XP</h3>
            <div id="current-list"></div>
            <button class="btn btn-success" style="margin-top: 15px;" onclick="finishWorkout()">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
        </div>

        <div class="card">
            <h3 style="font-size:14px; opacity:0.7">–ò—Å—Ç–æ—Ä–∏—è</h3>
            <div id="history-list" style="max-height: 300px; overflow-y: auto;"></div>
            <button class="btn btn-outline" style="border-color: var(--red); color: var(--red); margin-top:15px; width:100%" onclick="safeReset()">üß® –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å (Reset)</button>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <div class="card" style="text-align: center;">
            <div style="font-size: 60px; margin-bottom: 10px;">üèÜ</div>
            <h2 id="res-header-praise">–¢—ã –º–∞—à–∏–Ω–∞!</h2>
            <div id="res-diff-badge" class="diff-badge hidden"></div>
            
            <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin: 20px 0;">
                <div style="font-size: 12px; opacity: 0.7;">XP –ü–æ–ª—É—á–µ–Ω–æ</div>
                <div style="font-size: 42px; font-weight: 900; color: var(--gold);" id="res-xp">+0</div>
            </div>

            <div class="stat-grid">
                <div><div class="stat-val" id="res-vol">0</div><div class="stat-label">–¢–æ–Ω–Ω–∞–∂</div></div>
                <div><div class="stat-val" id="res-kcal">0</div><div class="stat-label">–ö–∫–∞–ª</div></div>
                <div><div class="stat-val" id="res-time">0</div><div class="stat-label">–ú–∏–Ω</div></div>
            </div>
            
            <div id="res-tip" class="hint-block" style="display:block; text-align: left; margin-top: 15px; border-color: var(--tg-link);"></div>
            <button class="btn btn-primary" style="margin-top: 20px;" onclick="closeResult()">–û—Ç–ª–∏—á–Ω–æ</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.BackButton.onClick(() => {
           if(document.getElementById('screen-result').style.display === 'block') {
               closeResult();
           } else if(document.getElementById('screen-profile').style.display === 'block' && profile) {
               showScreen('screen-main');
           }
        });

        const EX_DB = {
            chest: [
                ["–ñ–∏–º –ª–µ–∂–∞ (–®—Ç–∞–Ω–≥–∞)", 0, 1], ["–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –ª–µ–∂–∞", 0, 2, {db:true}],
                ["–ñ–∏–º –ø–æ–¥ —É–≥–ª–æ–º (–®—Ç–∞–Ω–≥–∞)", 0, 1], ["–ñ–∏–º –ø–æ–¥ —É–≥–ª–æ–º (–ì–∞–Ω—Ç–µ–ª–∏)", 0, 2, {db:true}],
                ["–û—Ç–∂–∏–º–∞–Ω–∏—è", 1, 0], ["–ë—Ä—É—Å—å—è", 1, 0], ["–ë–∞–±–æ—á–∫–∞", 4, 1, {mach:true}]
            ],
            back: [
                ["–°—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞", 0, 1], ["–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è", 1, 0], 
                ["–¢—è–≥–∞ —à—Ç–∞–Ω–≥–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ", 0, 1], ["–¢—è–≥–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞", 4, 1, {mach:true}], 
                ["–¢—è–≥–∞ –Ω–∏–∂–Ω–µ–≥–æ –±–ª–æ–∫–∞", 4, 1, {mach:true}], 
                ["–¢—è–≥–∞ –≥–∞–Ω—Ç–µ–ª–∏ (–æ–¥–Ω–æ–π —Ä—É–∫–æ–π)", 0, 1, {uni:true}], 
                ["–ì–∏–ø–µ—Ä—ç–∫—Å—Ç–µ–Ω–∑–∏—è", 1, 0], 
                ["–ü—É–ª–æ–≤–µ—Ä", 0, 1, {}]
            ],
            legs: [
                ["–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è (–®—Ç–∞–Ω–≥–∞)", 0, 1], ["–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è (–ö—É–±–æ–∫/–ì–∞–Ω—Ç–µ–ª—å)", 0, 1, {}],
                ["–ñ–∏–º –Ω–æ–≥–∞–º–∏", 4, 1, {mach:true}], ["–†—É–º—ã–Ω—Å–∫–∞—è —Ç—è–≥–∞", 0, 1],
                ["–í—ã–ø–∞–¥—ã (–ì–∞–Ω—Ç–µ–ª–∏)", 0, 2, {db:true, uni:true}], ["–í—ã–ø–∞–¥—ã (–°–≤–æ–π –≤–µ—Å)", 1, 0, {uni:true}],
                ["–ë–æ–ª–≥–∞—Ä—Å–∫–∏–µ –≤—ã–ø–∞–¥—ã", 0, 2, {db:true, uni:true}], ["–†–∞–∑–≥–∏–±–∞–Ω–∏–µ –Ω–æ–≥", 4, 1, {mach:true}], ["–°–≥–∏–±–∞–Ω–∏–µ –Ω–æ–≥", 4, 1, {mach:true}]
            ],
            shoulders: [
                ["–ê—Ä–º–µ–π—Å–∫–∏–π –∂–∏–º", 0, 1], ["–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π —Å–∏–¥—è", 0, 2, {db:true}],
                ["–ú–∞—Ö–∏ –≤ —Å—Ç–æ—Ä–æ–Ω—ã", 0, 2, {db:true}], ["–ú–∞—Ö–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ", 0, 2, {db:true}], 
                ["–¢—è–≥–∞ –∫ –ª–∏—Ü—É", 4, 1, {face:true}]
            ],
            arms: [
                ["–ü–æ–¥—ä–µ–º –Ω–∞ –±–∏—Ü–µ–ø—Å (–®—Ç–∞–Ω–≥–∞)", 0, 1], ["–ü–æ–¥—ä–µ–º –≥–∞–Ω—Ç–µ–ª–µ–π (–ë–∏—Ü–µ–ø—Å)", 0, 2, {db:true}], ["–ú–æ–ª–æ—Ç–∫–∏", 0, 2, {db:true}],
                ["–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∂–∏–º", 0, 1], ["–†–∞–∑–≥–∏–±–∞–Ω–∏–µ –Ω–∞ –±–ª–æ–∫–µ", 4, 1, {mach:true}]
            ],
            abs: [
                ["–°–∫—Ä—É—á–∏–≤–∞–Ω–∏—è", 1, 0], ["–ü–æ–¥—ä–µ–º –Ω–æ–≥", 1, 0], 
                ["–ü–ª–∞–Ω–∫–∞", 2, 0], ["–†—É—Å—Å–∫–∏–π —Ç–≤–∏—Å—Ç", 1, 0]
            ],
            // –£–±—Ä–∞–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç—ã, –æ—Å—Ç–∞–≤–∏–ª–∏ —á–∏—Å—Ç–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
            cardio: [
                ["–ë–µ–≥", 3, 0], ["–•–æ–¥—å–±–∞", 3, 0], 
                ["–≠–ª–ª–∏–ø—Å", 3, 0], ["–í–µ–ª–æ—Ç—Ä–µ–Ω–∞–∂–µ—Ä", 3, 0], ["–ì—Ä–µ–±–ª—è", 3, 0]
            ]
        };

        const LEVELS = [
            { xp: 0, icon: "ü•ö", rank: "–Ø–π—Ü–æ" }, { xp: 500, icon: "üê£", rank: "–ù–æ–≤–∏—á–æ–∫" },
            { xp: 2000, icon: "üê•", rank: "–õ—é–±–∏—Ç–µ–ª—å" }, { xp: 5000, icon: "üêì", rank: "–ë–æ–µ—Ü" },
            { xp: 12000, icon: "üêó", rank: "–ê—Ç–ª–µ—Ç" }, { xp: 30000, icon: "ü¶ç", rank: "–ú–∞—à–∏–Ω–∞" },
            { xp: 70000, icon: "ü¶ñ", rank: "–¢–∏—Ç–∞–Ω" }, { xp: 150000, icon: "üëë", rank: "–ö–æ—Ä–æ–ª—å" }
        ];

        const TIPS = {
            strength: ["–û—Ç–¥—ã—Ö–∞–π 3-5 –º–∏–Ω—É—Ç –Ω–∞ —Ç—è–∂–µ–ª—ã—Ö –≤–µ—Å–∞—Ö.", "–ü—Ä–æ–≥—Ä–µ—Å—Å–∏—è –Ω–∞–≥—Ä—É–∑–æ–∫ ‚Äî –∫–ª—é—á –∫ —Ä–æ—Å—Ç—É."],
            muscle: ["–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π –æ–ø—É—Å–∫–∞–Ω–∏–µ –≤–µ—Å–∞.", "–î–µ–ª–∞–π 8-12 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π –≤ –æ—Ç–∫–∞–∑."],
            fatloss: ["–¢–≤–æ–π –≥–ª–∞–≤–Ω—ã–π –∂–∏—Ä–æ—Å–∂–∏–≥–∞—Ç–µ–ª—å ‚Äî —ç—Ç–æ –¥–µ—Ñ–∏—Ü–∏—Ç –µ–¥—ã.", "–°–∏–ª–æ–≤—ã–µ –¥–µ—Ä–∂–∞—Ç –º—ã—à—Ü—ã."],
            health: ["–°–ª—É—à–∞–π —Å–≤–æ–µ —Ç–µ–ª–æ.", "–ù–µ –ø—Ä–æ–ø—É—Å–∫–∞–π —Ä–∞–∑–º–∏–Ω–∫—É."]
        };
        
        const PRAISE_WORDS = ["–¢—ã –º–∞—à–∏–Ω–∞!", "–ú–æ—â–Ω–æ!", "–¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!", "–ó–≤–µ—Ä—å!", "–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!", "–õ–µ–≥–∫–∏–π –≤–µ—Å!"];

        const MET_CARDIO = {
            "–ë–µ–≥": {3:8, 6:9.8, 9:11.5, 11:15}, // –°–ø—Ä–∏–Ω—Ç —Ç–µ–ø–µ—Ä—å —Ç—É—Ç (11)
            "–•–æ–¥—å–±–∞": {3:2.5, 5:3.5, 7:5.0},
            "–≠–ª–ª–∏–ø—Å": {3:5, 6:7, 9:9, 11:10},
            "–í–µ–ª–æ—Ç—Ä–µ–Ω–∞–∂–µ—Ä": {3:5, 6:7, 9:9.5, 11:11},
            "–ì—Ä–µ–±–ª—è": {3:6, 6:8.5, 9:12, 11:14}
        };

        let profile = JSON.parse(localStorage.getItem('ip_profile'));
        let history = JSON.parse(localStorage.getItem('ip_history')) || [];
        let currentSession = JSON.parse(localStorage.getItem('ip_current')) || [];
        let personalRecords = JSON.parse(localStorage.getItem('ip_prs')) || {};
        let totalXP = parseInt(localStorage.getItem('ip_xp')) || 0;
        let lastExName = null; 

        init();

        function init() {
            tg.ready();
            // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –Ω–µ—Ç –ø—Ä–æ—Ñ–∏–ª—è - –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
            if (!profile || !profile.weight) {
                showScreen('screen-onboarding');
            } else { 
                showScreen('screen-main'); 
                updateExList(); 
                renderMain(); 
            }
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById(id).classList.add('active-screen');
            window.scrollTo(0,0);
            
            if(id === 'screen-main') tg.BackButton.hide();
            else tg.BackButton.show();
        }

        function updateExList() {
            const cat = document.getElementById('select-cat').value;
            const exSelect = document.getElementById('select-ex');
            exSelect.innerHTML = EX_DB[cat].map((ex, idx) => `<option value="${idx}">${ex[0]}</option>`).join('');
            exSelect.value = 0; 
            adaptInputs(); 
        }

        function adaptInputs() {
            const cat = document.getElementById('select-cat').value;
            const exIdx = document.getElementById('select-ex').value;
            const [name, type, mult, flags] = EX_DB[cat][exIdx];
            const f = flags || {};

            const prEl = document.getElementById('pr-display');
            const currentPR = personalRecords[name] || 0;
            
            if (type !== 3 && currentPR > 0) {
                prEl.innerText = `üèÜ PR: ${currentPR}–∫–≥`;
                prEl.classList.add('visible');
            } else {
                prEl.classList.remove('visible');
            }

            const strBlock = document.getElementById('input-container-strength');
            const cardioBlock = document.getElementById('input-container-cardio');
            
            document.querySelectorAll('.hint-block').forEach(el => el.classList.remove('visible'));
            
            if (lastExName !== name) {
                document.getElementById('input-w').value = ''; 
                document.getElementById('input-r').value = '';
                document.getElementById('input-cardio-time').value = '';
            }
            
            if (type === 3) { 
                strBlock.classList.add('hidden'); 
                cardioBlock.classList.remove('hidden'); 
                
                const iSelect = document.getElementById('input-cardio-intensity');
                let iMap = {3: "–õ–∞–π—Ç", 6: "–°—Ä–µ–¥–Ω–µ", 9: "–¢—è–∂–µ–ª–æ", 11: "–ú–∞–∫—Å–∏–º—É–º"};
                if (name === "–•–æ–¥—å–±–∞") iMap = {3: "–ü—Ä–æ–≥—É–ª–∫–∞", 5: "–ë–æ–¥—Ä—ã–π —à–∞–≥", 7: "–í –≥–æ—Ä—É / –°–ø–µ—à–∫–∞"};
                
                iSelect.innerHTML = Object.entries(iMap).map(([val, txt]) => 
                    `<option value="${val}" ${val==6?'selected':''}>${txt}</option>`
                ).join('');
            
            } else { 
                cardioBlock.classList.add('hidden'); 
                strBlock.classList.remove('hidden'); 
                
                if (f.db) document.getElementById('hint-dumbbell').classList.add('visible');
                if (f.uni) document.getElementById('hint-unilateral').classList.add('visible');
                if (f.mach) document.getElementById('hint-machine').classList.add('visible');
                if (f.face) document.getElementById('hint-facepull').classList.add('visible');
                if (type === 1 || name === "–ü–ª–∞–Ω–∫–∞") document.getElementById('hint-bodyweight').classList.add('visible');

                const textW = document.getElementById('text-w-label');
                const lR = document.getElementById('label-r');
                
                textW.innerText = (type === 2 || type === 1) ? "–î–æ–ø. –≤–µ—Å (–∫–≥)" : "–í–µ—Å (–∫–≥)";
                lR.innerText = (type === 2) ? "–í—Ä–µ–º—è (—Å–µ–∫)" : "–ü–æ–≤—Ç–æ—Ä—ã";
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function addSet() {
            const cat = document.getElementById('select-cat').value;
            const exIdx = document.getElementById('select-ex').value;
            const [name, type, mult, flags] = EX_DB[cat][exIdx];
            
            let w = 0, r = 0, kcal = 0, vol = 0, xp = 0;
            // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤–µ—Å —Ç–µ–ª–∞, –µ—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å —Å–±–∏–ª—Å—è
            const safeBodyWeight = (profile && profile.weight > 0) ? parseFloat(profile.weight) : 75;

            if (type === 3) { // –ö–ê–†–î–ò–û
                const intensityKey = document.getElementById('input-cardio-intensity').value; 
                const duration = parseFloat(document.getElementById('input-cardio-time').value);
                
                if (!duration) return tg.showAlert("–£–∫–∞–∂–∏ –≤—Ä–µ–º—è!");
                
                let realMET = parseFloat(intensityKey);
                if (MET_CARDIO[name] && MET_CARDIO[name][intensityKey]) {
                    realMET = MET_CARDIO[name][intensityKey];
                }

                // –§–æ—Ä–º—É–ª–∞: MET * 3.5 * –≤–µ—Å / 200 * –º–∏–Ω—É—Ç—ã
                kcal = (realMET * 3.5 * safeBodyWeight / 200) * duration; 
                xp = Math.round(kcal * 1.5);
                r = duration; 
                vol = duration; 
            
            } else { // –°–ò–õ–û–í–´–ï
                w = parseFloat(document.getElementById('input-w').value) || 0;
                r = parseFloat(document.getElementById('input-r').value);
                
                if (!r) return tg.showAlert("–£–∫–∞–∂–∏ –ø–æ–≤—Ç–æ—Ä—ã!");

                if (w > (personalRecords[name] || 0) && type !== 2) {
                    personalRecords[name] = w;
                    localStorage.setItem('ip_prs', JSON.stringify(personalRecords));
                    showToast(`üèÜ –ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥: ${w} –∫–≥!`);
                    tg.HapticFeedback.notificationOccurred('success');
                }

                let load = w;
                if (mult === 2) load = w * 2; 
                if (type === 1) load = 0; 
                vol = (type === 2) ? 0 : (load * r);

                // --- –†–ï–ê–õ–ò–°–¢–ò–ß–ù–ê–Ø –§–û–†–ú–£–õ–ê –î–õ–Ø –°–ò–õ–û–í–´–• (–ó–∞ –ø–æ–¥—Ö–æ–¥) ---
                let workingWeight = (type === 1) ? safeBodyWeight : ( (type === 4) ? w : load );
                let intensityRatio = Math.max(0.3, Math.min(1.5, workingWeight / safeBodyWeight));
                
                // MET –æ—Ç 3.5 (–ª–µ–≥–∫–æ) –¥–æ 6.0 (—Ç—è–∂–µ–ª–æ)
                let MET = 3.5 + (intensityRatio * 1.7);
                if (MET > 6) MET = 6;

                // –í—Ä–µ–º—è –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π –≤ –º–∏–Ω—É—Ç–∞—Ö (1 –ø–æ–≤—Ç–æ—Ä ~ 3 —Å–µ–∫)
                let minutes = (type === 2) ? (r / 60) : (r * 3 / 60);
                
                // –ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–µ –∫–∞–ª–æ—Ä–∏–∏ –∑–∞ –ø–æ–¥—Ö–æ–¥
                kcal = (MET * 3.5 * safeBodyWeight / 200) * minutes;
                if (kcal < 2) kcal = 2; // –ú–∏–Ω–∏–º—É–º 2 –∫–∫–∞–ª –∑–∞ —É—Å–∏–ª–∏–µ

                // XP —Ç–µ–ø–µ—Ä—å –±–æ–ª—å—à–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ–±—ä–µ–º–∞ (vol) –∏ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏, –∞ –Ω–µ –æ—Ç "–¥—É—Ç—ã—Ö" –∫–∞–ª–æ—Ä–∏–π
                let liftXP = (type === 1) ? (r * 2.5) : (vol / 15 + w * 0.4);
                xp = Math.round(liftXP + kcal);
            }

            currentSession.unshift({ id: Date.now(), name, vol, kcal: Math.round(kcal), xp, w, r, type });
            saveSession();
            tg.HapticFeedback.impactOccurred('medium');
            renderMain();
            adaptInputs(); 
            
            lastExName = name;
            // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–≤—Ç–æ—Ä—ã, –≤–µ—Å –æ—Å—Ç–∞–≤–ª—è–µ–º (—É–¥–æ–±–Ω–æ –¥–ª—è —Å–ª–µ–¥. –ø–æ–¥—Ö–æ–¥–∞)
            if (type !== 3) {
                document.getElementById('input-r').value = ''; 
            }
        }

        function finishWorkout() {
            if (currentSession.length === 0) return;

            const vol = currentSession.reduce((a, c) => a + c.vol, 0);
            const mechKcal = currentSession.reduce((a, c) => a + c.kcal, 0);
            
            // --- –ë–û–ù–£–° –ó–ê –û–ë–©–£–Æ –ê–ö–¢–ò–í–ù–û–°–¢–¨ (EPOC + –û—Ç–¥—ã—Ö) ---
            // –°—á–∏—Ç–∞–µ–º –≤—Ä–µ–º—è: –∫–∞—Ä–¥–∏–æ + –ø–æ 2.5 –º–∏–Ω—É—Ç—ã –Ω–∞ –∫–∞–∂–¥—ã–π —Å–∏–ª–æ–≤–æ–π –ø–æ–¥—Ö–æ–¥
            let sessionMinutes = Math.round(cardioMins + strengthSets * 2.5);
            let baseMET = 3.0; // –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–æ—Å—Ç–æ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –≤ –∑–∞–ª–µ
            let sessionKcalBonus = (baseMET * 3.5 * (profile.weight || 80) / 200) * sessionMinutes;
            
            let totalKcal = Math.round(mechKcal + sessionKcalBonus);
            
            let xp = currentSession.reduce((a, c) => a + c.xp, 0);
            if (xp > 15000) xp = 15000;

            let cardioMins = 0, strengthSets = 0;
            currentSession.forEach(s => {
                if (s.type === 3) cardioMins += s.r; else strengthSets++;
            });
            let sessionType = (cardioMins > strengthSets * 3) ? 'cardio' : 'strength';

            let diffPercent = 0;
            let diffType = 'neutral';
            
            if (history.length > 0) {
                const prev = history.find(h => (h.type || 'strength') === sessionType);
                if (prev) {
                    // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –§–ò–ó–ò–ß–ï–°–ö–ò–ï –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏, –∞ –Ω–µ XP
                    let currVal = (sessionType === 'cardio') ? record.time : record.vol;
                    let prevVal = (sessionType === 'cardio') ? prev.time : prev.vol;
                    
                    if (prevVal > 0) {
                        diffPercent = ((currVal - prevVal) / prevVal) * 100;
                        if (diffPercent > 3) diffType = 'pos';
                        if (diffPercent < -3) diffType = 'neg';
                    }
                }
            }

            const record = {
                date: Date.now(),
                dateStr: new Date().toLocaleDateString('ru-RU', {day:'numeric', month:'short'}),
                vol, kcal, xp, time: Math.round(cardioMins + strengthSets*3), type: sessionType
            };
            
            history.unshift(record);
            totalXP += xp;
            
            localStorage.setItem('ip_history', JSON.stringify(history));
            localStorage.setItem('ip_xp', totalXP);
            localStorage.removeItem('ip_current');
            currentSession = [];

            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            document.getElementById('res-xp').innerText = `+${Math.round(xp)}`;
            document.getElementById('res-vol').innerText = (sessionType === 'cardio') ? "–ö–∞—Ä–¥–∏–æ" : vol;
            document.getElementById('res-kcal').innerText = Math.round(kcal); 
            document.getElementById('res-time').innerText = record.time;
            
            // –ú–û–¢–ò–í–ê–¶–ò–û–ù–ù–´–ô –ó–ê–ì–û–õ–û–í–û–ö
            document.getElementById('res-header-praise').innerText = PRAISE_WORDS[Math.floor(Math.random() * PRAISE_WORDS.length)];

            const tipsArr = TIPS[profile.goal] || TIPS['health'];
            document.getElementById('res-tip').innerHTML = "üí° " + tipsArr[Math.floor(Math.random() * tipsArr.length)];

            const badge = document.getElementById('res-diff-badge');
            if (diffType !== 'neutral') {
                badge.className = 'diff-badge ' + (diffType === 'pos' ? 'diff-pos' : 'diff-neg');
                badge.innerText = (diffType === 'pos' ? '‚ñ≤' : '‚ñº') + ` ${Math.abs(diffPercent).toFixed(1)}%`;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            showScreen('screen-result');
            tg.HapticFeedback.notificationOccurred('success');
            renderMain();
        }

        function closeResult() {
            showScreen('screen-main');
        }

        function deleteSet(id) {
            currentSession = currentSession.filter(s => s.id !== id);
            saveSession();
            renderMain();
        }
        
        function safeReset() {
            if(confirm("–£–¥–∞–ª–∏—Ç—å –í–ï–°–¨ –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ?")) {
                const keys = ['ip_profile', 'ip_history', 'ip_current', 'ip_prs', 'ip_xp'];
                keys.forEach(k => localStorage.removeItem(k));
                location.reload();
            }
        }
        
        function deleteHistoryItem(index) {
            if(confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏?")) {
                const item = history[index];
                if (item.xp) totalXP = Math.max(0, totalXP - item.xp);
                history.splice(index, 1);
                localStorage.setItem('ip_history', JSON.stringify(history));
                localStorage.setItem('ip_xp', totalXP);
                renderMain();
            }
        }

        function saveSession() { localStorage.setItem('ip_current', JSON.stringify(currentSession)); }
        
        function saveProfile() {
            const w = parseFloat(document.getElementById('prof-weight').value);
            const h = parseFloat(document.getElementById('prof-height').value);
            const a = parseFloat(document.getElementById('prof-age').value);
            if (!w || !h || !a) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!");
            
            profile = { 
                weight: w, height: h, age: a, 
                gender: document.getElementById('prof-gender').value, 
                goal: document.getElementById('prof-goal').value 
            };
            localStorage.setItem('ip_profile', JSON.stringify(profile));
            showScreen('screen-main'); updateExList(); renderMain();
        }

        function updateCharacter() {
            let rank = "–Ø–π—Ü–æ", icon = "ü•ö", next = 500, lvl = 1;
            
            for (let i = 0; i < LEVELS.length; i++) {
                if (totalXP >= LEVELS[i].xp) {
                    rank = LEVELS[i].rank;
                    icon = LEVELS[i].icon;
                    lvl = i + 1;
                } else {
                    next = LEVELS[i].xp;
                    break;
                }
            }
            if (totalXP >= LEVELS[LEVELS.length-1].xp) next = "MAX";

            document.getElementById('main-char-icon').innerText = icon;
            document.getElementById('main-char-rank').innerText = rank;
            document.getElementById('stat-lvl').innerText = lvl;
            document.getElementById('main-char-xp').innerText = `${Math.floor(totalXP)} XP`;
            document.getElementById('main-char-next').innerText = (next === "MAX") ? "MAX" : `–¶–µ–ª—å: ${next}`;
            
            let prevXP = 0;
            for(let i=0; i<LEVELS.length; i++) {
                if(totalXP >= LEVELS[i].xp) prevXP = LEVELS[i].xp;
                else break;
            }
            
            let progress = 100;
            if(next !== "MAX") {
                progress = ((totalXP - prevXP) / (next - prevXP)) * 100;
            }
            document.getElementById('xp-fill').style.width = `${Math.max(0, Math.min(100, progress))}%`;
        }

        function renderMain() {
            document.getElementById('stat-xp').innerText = Math.round(totalXP).toLocaleString();
            document.getElementById('stat-count').innerText = history.length;
            
            updateCharacter(); 

            const curBlock = document.getElementById('current-session-block');
            if (currentSession.length > 0) {
                curBlock.classList.remove('hidden');
                let curXP = currentSession.reduce((a,c)=>a+c.xp,0);
                document.getElementById('session-title').innerText = `–°–µ–π—á–∞—Å: +${Math.round(curXP)} XP`;
                
                document.getElementById('current-list').innerHTML = currentSession.map(s => `
                    <div class="list-item">
                        <div><b>${s.name}</b><div style="font-size:12px; opacity:0.7">${s.type===3?s.r+' –º–∏–Ω':(s.type===2?s.r+' —Å–µ–∫':(s.w>0?s.w+'–∫–≥ √ó ':'')+s.r)}</div></div>
                        <div style="text-align:right; display:flex; align-items:center;">
                            <span style="color:var(--gold); font-weight:bold">+${s.xp} XP</span>
                            <div class="del-btn" onclick="deleteSet(${s.id})">‚úï</div>
                        </div>
                    </div>`).join('');
            } else { curBlock.classList.add('hidden'); }

            document.getElementById('history-list').innerHTML = history.map((h, i) => {
                let emoji = h.type === 'cardio' ? 'üèÉ' : 'üèãÔ∏è‚Äç‚ôÇÔ∏è';
                let detailText = (h.type === 'cardio') 
                    ? `${h.time} –º–∏–Ω` 
                    : `${h.time} –º–∏–Ω ‚Ä¢ ${h.vol} –∫–≥`;

                return `
                <div class="list-item">
                    <div>
                        <div style="font-weight:600">${emoji} ${h.dateStr}</div>
                        <div style="font-size:12px; opacity:0.7">${detailText}</div>
                    </div>
                    <div style="text-align:right">
                         <div style="color:var(--gold); font-weight:bold">+${Math.round(h.xp)}</div>
                         <div style="font-size:10px; opacity:0.5; color:var(--red); margin-top:4px;" onclick="deleteHistoryItem(${i})">—É–¥–∞–ª–∏—Ç—å</div>
                    </div>
                </div>`;
            }).join('');
        }
    </script>
</body>
</html>